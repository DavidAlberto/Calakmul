---
title: "Calakmul, análisis metagenómico" 
subtitle: "16s"
author: "David Alberto García Estrada"
date: "21/2/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Análisis de datos de rRNA 16s con DADA2 y Mothur, basado en curso de [CastroLab](http://www.castrolab.org/isme/dada2/dada2.html)

# Paquetes para en análisis de datos
## Definir paquetes
```{r}
## Repositorio CRAN
cran_packages <- c("bookdown", "knitr", "tidyverse", "plyr", "grid", "gridExtra", "kableExtra", "xtable", "ggpubr")
## Repositorio Bioconductor
bioc_packages <- c("phyloseq", "dada2", "DECIPHER", "phangorn", "ggpubr", "BiocManager","DESeq2", "microbiome", "philr")
## Repositorio GitHub
git_source <- c("twbattaglia/btools", "gmteunisse/Fantaxtic", "MadsAlbertsen/ampvis2", "opisthokonta/tsnemicrobiota")
# fuente/nombre del paquete
git_packages <- c("btools", "fantaxtic", "ampvis2", "tsnemicrobiota") #Nombre del paquete
```

## Instalar paquetes
```{r}
# Intalar paquetes CRAN
.inst <- cran_packages %in% installed.packages()
if(any(!.inst)) {
  install.packages(cran_packages[!.inst])
}
# Intalar paquetes BioConductor
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
.inst <- bioc_packages %in% installed.packages()
if(any(!.inst)) {
  BiocManager::install(bioc_packages[!.inst])
}
# Instalar paquetes GitHub
.inst <- git_source %in% installed.packages()
install.packages("devtools")
if(any(!.inst)) {
  devtools::install_github(git_source[!.inst])
}
library("devtools")
install_github("opisthokonta/tsnemicrobiota")
install.packages("remotes")
remotes::install_github("kasperskytte/ampvis2")
devtools::install_github('twbattaglia/btools')
```

## Cargar paquetes
```{r}
sapply(c(cran_packages, bioc_packages, git_packages), require, character.only = TRUE)
library("phyloseq")
library("ggplot2")
library("readr")
library("patchwork")
library("pheatmap")
library("microbiome")
library("xtable")
library("tsnemicrobiota")
library("Rtsne")
library("ampvis2")
library("btools")
```

# **DADA2**
## Metadatos
Los datos con los que trabajamos son obtenidos de secuenciación del **rRNA 16s** de muestras tomadas de **Calakmul**
Son un total *10 muestras*, y el tipo de secuenciación fue `paired-end` mediante la herramienta Illumina.
Estos son los metadatos que se tienen:

|   **ID**  | **SITE** |  **LATITUDE** | **LONGITUDE** |  **MONTH** | **YEAR** | **pH** | **N_TOTAL** | **P_OLSEN** | **ORGANIC** | **TYPE** | **SITE_ID** |        **FILES_R1**       |        **FILES_R2**       |   **SAMPLE**  |
|:---------:|:--------:|:-------------:|:-------------:|:----------:|:--------:|:------:|:-----------:|:-----------:|:-----------:|:--------:|:-----------:|:-------------------------:|:-------------------------:|:-------------:|
| Ag1_Sep17 |     2    |  18°22'0.40"N |  89°53'7.30"O | September  |   2017   |   6.2  |     0.36    |     29.6    |      12     | 16S rRNA |     Ag1     |  zr2757_2V3V4_R1.fastq.gz |  zr2757_2V3V4_R2.fastq.gz |  zr2757_2V3V4 |
| Ag1_Sep18 |     2    |  18°22'0.40"N |  89°53'7.30"O | September  |   2018   |   6.2  |     0.36    |     29.6    |      12     | 16S rRNA |     Ag1     |  zr2757_8V3V4_R1.fastq.gz |  zr2757_8V3V4_R2.fastq.gz |  zr2757_8V3V4 |
| Ag1_Sep19 |     2    |  18°22'0.40"N |  89°53'7.30"O | September  |   2019   |   6.2  |     0.36    |     29.6    |      12     | 16S rRNA |     Ag1     |  zr2757_9V3V4_R1.fastq.gz |  zr2757_9V3V4_R2.fastq.gz |  zr2757_9V3V4 |
| Ag2_Sep17 |     3    | 18°21'34.50"N | 89°54'14.60"O | September  |   2017   |   6.7  |     0.22    |     13.5    |     13.5    | 16S rRNA |     Ag2     | zr2757_10V3V4_R1.fastq.gz | zr2757_10V3V4_R2.fastq.gz | zr2757_10V3V4 |
| Ag2_Sep18 |     3    | 18°21'34.50"N | 89°54'14.60"O | September  |   2018   |   6.7  |     0.22    |     13.5    |     13.5    | 16S rRNA |     Ag2     |  zr2757_6V3V4_R1.fastq.gz |  zr2757_6V3V4_R2.fastq.gz |  zr2757_6V3V4 |
| Ag2_Sep19 |     3    | 18°21'34.50"N | 89°54'14.60"O | September  |   2019   |   6.7  |     0.22    |     13.5    |     13.5    | 16S rRNA |     Ag2     |  zr2757_5V3V4_R1.fastq.gz |  zr2757_5V3V4_R2.fastq.gz |  zr2757_5V3V4 |
| Ag3_Jun19 |     1    | 18°24'24.40"N | 89°53'54.70"O |    June    |   2019   |   6.1  |     0.29    |      4      |     24.2    | 16S rRNA |     Ag3     |  zr2757_4V3V4_R1.fastq.gz |  zr2757_4V3V4_R2.fastq.gz |  zr2757_4V3V4 |
| Ag3_Sep17 |     1    | 18°24'24.40"N | 89°53'54.70"O | September  |   2017   |   6.1  |     0.29    |      4      |     24.2    | 16S rRNA |     Ag3     |  zr2757_1V3V4_R1.fastq.gz |  zr2757_1V3V4_R2.fastq.gz |  zr2757_1V3V4 |
| Ag3_Sep18 |     1    | 18°24'24.40"N | 89°53'54.70"O | September  |   2018   |   6.1  |     0.29    |      4      |     24.2    | 16S rRNA |     Ag3     |  zr2757_3V3V4_R1.fastq.gz |  zr2757_3V3V4_R2.fastq.gz |  zr2757_3V3V4 |
| Ag3_Sep19 |     1    | 18°24'24.40"N | 89°53'54.70"O | September  |   2019   |   6.1  |     0.29    |      4      |     24.2    | 16S rRNA |     Ag3     |  zr2757_7V3V4_R1.fastq.gz |  zr2757_7V3V4_R2.fastq.gz |  zr2757_7V3V4 |

Vamos a correr nuestros datos según la pipeline **DADA2**. 
**DADA2** ofrece ventajas con respecto a la estrategia de formar clusters (OTUs) en varios aspectos que incluyen *mayor resolución*, *nombres consistentes entre diferentes análisis*, *mejor estimación de abundancias relativas*, etc. 

## Directorio de trabajo
Ajustamos directorio de trabajo donde se encuentran las lecturas "reads"
```{r}
setwd("//wsl.localhost/Ubuntu/home/davidalbertoge/Metagenomica/16s")
miseq_path <- "//wsl.localhost/Ubuntu/home/davidalbertoge/Metagenomica/16s"
dir.create("//wsl.localhost/Ubuntu/home/davidalbertoge/Metagenomica/16s/Resultados/")
list.files(miseq_path)
```

## Ordenamos las lecturas
En **DADA2** las reads se trabajan inicialmente por separado, es decir, la copia forward o R1 separada de la copia reverse o R2. Por esto, nos tenemos que asegurar que ambos archivos estén ordenados. Luego, manipulamos el nombre de los archivos para generar automáticamente el nombre de las muestras en nuestro análisis:
```{r}
fnFs <- sort(list.files(miseq_path, pattern="_R1.fastq.gz"))
fnRs <- sort(list.files(miseq_path, pattern="_R2.fastq.gz"))

# Extracción del nombre de las muestras
sampleNames <- sapply(strsplit(fnFs, "_R"), `[`, 1)
sampleNames
# Especificamos el path completo para evitar errores de ambigüedad
fnFs <- file.path(miseq_path, fnFs)
fnRs <- file.path(miseq_path, fnRs)
fnFs
fnRs
```

## Visualización de calidad
El paquete **DADA2** tiene muchas funciones útiles para el pre-procesamiento de los datos. A continuación se visualiza el perfil de calidad de las muestras para cada par de 5’ a 3’:
```{r}
plotQualityProfile(fnFs[1:2]) #Solo de las primeras 2  
plotQualityProfile(fnRs[1:2]) #Solo de las primeras 2 
```
## Filtrado y corte
Ahora vamos a proceder con el filtrado y corte de las reads de acuerdo a lo observado en los gráficos de calidad. Primero creamos un directorio donde vamos a poner las reads una vez realizado el control de calidad, y luego realizamos dicho control. En específico usamos los argumentos 
- trunLen = corte promedio de cada read
- maxN = número máximo de bases indeterminadas
- maxEE = número máximo de errores
- truncQ = Corta lecturas que el valor de calidad es menor a un valor
- rm.phix = si es que queremos remover secuencias pertenecientes al control interno de Illumina
```{r}
# Creamos un directorio para poner las reads "limpias"
filt_path <- file.path(miseq_path, "Filtered") 
filt_path
if(!file_test("-d", filt_path)) dir.create(filt_path)
filtFs <- file.path(filt_path, paste0(sampleNames, "_F_filt.fastq.gz"))
filtRs <- file.path(filt_path, paste0(sampleNames, "_R_filt.fastq.gz"))

# Y finalmente procedemos con el control de calidad
out <- filterAndTrim(fnFs, filtFs, fnRs, filtRs, truncLen=c(300,250),
              maxN=0, maxEE=c(2,2), truncQ=2, rm.phix=TRUE,
              compress=TRUE, multithread=FALSE) 
# Si usan Windows, configuren multithread=FALSE
```

**DADA2** genera un modelo probabilístico de errores con el cual puede filtrar reads erróneas y así usar las restantes directamente para la etapa de clasificación taxonómica. Esta parte del método es la que nos permite tener una mayor resolución en comparación a los análisis basados en OTUs. 

## De-replicar
Como las muestras probablemente tienen reads idénticas, no es eficiente usar cada una de ellas para los pasos río abajo. Por esto, **DADA2** recomienda *de-replicar* las muestras para así disminuir la redundancia y avanzar eficientemente.
```{r}
# De-replicar
derepFs <- derepFastq(filtFs, verbose=TRUE)
derepRs <- derepFastq(filtRs, verbose=TRUE)

# Acá simplemente agregamos los nombres de las muestras al objeto de-replicado
names(derepFs) <- sampleNames
names(derepRs) <- sampleNames
```
Una vez con las muestras de-replicadas procedemos a generar un modelo de errores. Para mayor detalle sobre este crucial paso revisen el artículo original [aquí](https://www.nature.com/articles/nmeth.3869).
```{r}
errF <- learnErrors(filtFs, multithread=TRUE)
errR <- learnErrors(filtRs, multithread=TRUE)

# Graficamos los errores para cada par
plotErrors(errF, nominalQ=TRUE)
plotErrors(errR, nominalQ=TRUE)
```
Se muestran las tasas de error para cada transición posible (A→C, A→G, …). Los puntos son las tasas de error observadas para cada puntaje de calidad de consenso. La línea negra muestra las tasas de error estimadas después de la convergencia del algoritmo de aprendizaje automático. La línea roja muestra las tasas de error esperadas según la definición nominal de la puntuación Q. 
Aquí, las tasas de error estimadas (línea negra) NO SE AJUSTA bien a las tasas observadas (puntos), y las tasas de error disminuyen con una mayor calidad pero NO como se esperaba. 

## Amplicon Sequence Variants (ASVs)
Con esta información procedemos al paso más importante de la pipeline, **la inferencia de las Amplicon Sequence Variants (ASVs)**.
```{r}
dadaFs <- dada(derepFs, err=errF, multithread=TRUE, pool = TRUE)
dadaRs <- dada(derepRs, err=errR, multithread=TRUE, pool = TRUE)
```

Inspeccionando el objeto de clase `dada` devuelto: 
```{r}
dadaFs[[1]]
dadaRs[[1]]
```
El algoritmo DADA2 infirió 3043 variantes de secuencia verdadera de las secuencias únicas de 37332 en la primera muestra y 2200 variantes de secuencia verdadera de las secuencias únicas de 38947 en la segunda muestra. Hay mucho más en el objeto de retorno de la clase *dada* que esto (consulte la ayuda ("clase dada") para obtener información), incluidos múltiples diagnósticos sobre la calidad de cada variante de secuencia eliminada, pero eso está más allá del alcance de un tutorial introductorio. 

## Combinar lecturas emparejadas
Ahora fusionamos las lecturas directa e reversa para obtener las secuencias completas sin ruido. La fusión se realiza alineando las lecturas directas eliminadas de ruido con el complemento revverso de las lecturas reversas eliminadas de ruido correspondientes, y luego construyendo las secuencias "contig" fusionadas. De forma predeterminada, las secuencias fusionadas solo se emiten si las lecturas directa e inversa se superponen en al menos 12 bases y son idénticas entre sí en la región de superposición (pero estas condiciones se pueden cambiar a través de argumentos de función). 
```{r}
# Unimos las reads
mergers <- mergePairs(dadaFs, derepFs, dadaRs, derepRs)
```
El objeto de `mergers` es una lista de marcos de datos de cada muestra. Cada data.frame contiene la `$secuencia fusionada`, su `$abundancia y los índices de las variantes de secuencia` `$forward` y `$reverse` que se fusionaron. `mergePairs` eliminó las lecturas emparejadas que no se superponían exactamente, lo que redujo aún más la salida espuria. 

## Construir tabla de secuencia
Ahora podemos construir una tabla de variantes de secuencia de amplicón (ASV), una versión de mayor resolución de la tabla OTU producida por métodos tradicionales.
```{r}
# Generamos una tabla de secuencias
seqtabAll <- makeSequenceTable(mergers[!grepl("Mock", names(mergers))])
dim(seqtabAll)
table(nchar(getSequences(seqtabAll)))
```
La tabla de secuencias es una matriz con filas correspondientes a (y nombradas por) las muestras y columnas correspondientes (y nombradas por) las variantes de secuencia. 

## Removemos quimeras
El método `dada` corrige errores de sustitución e indel, pero quedan quimeras (producto de la amplificación por PCR). Afortunadamente, la precisión de las variantes de secuencia después de eliminar el ruido hace que identificar ASV quiméricos sea más simple que cuando se trata de OTU difusas. Las secuencias quiméricas se identifican si pueden reconstruirse exactamente combinando un segmento izquierdo y un segmento derecho de dos secuencias "primarias" más abundantes. 
```{r}
seqtabNoC <- removeBimeraDenovo(seqtabAll, method="consensus", multithread=TRUE, verbose=TRUE)
dim(seqtabNoC)
sum(seqtabNoC)/sum(seqtabAll)
```
La frecuencia de las secuencias quiméricas varía sustancialmente de un conjunto de datos a otro y depende de factores que incluyen los procedimientos experimentales y la complejidad de la muestra. Cuando tomamos en cuenta la abundancia de esas variantes, vemos que representan alrededor del 22 % de las lecturas de secuencias fusionadas. 

## Seguimiento de lecturas a través de la canalización
Como verificación final de nuestro progreso, veremos la cantidad de lecturas que se realizaron en cada paso de la canalización: 
```{r}
getN <- function(x) sum(getUniques(x))
track <- cbind(out, sapply(dadaFs, getN), sapply(dadaRs, getN), sapply(mergers, getN), rowSums(seqtabNoC))
# Si procesa una sola muestra, elimine las llamadas de sapply: p. reemplace sapply(dadaFs, getN) con getN(dadaFs) 
colnames(track) <- c("input", "filtered", "denoisedF", "denoisedR", "merged", "nonchim")
rownames(track) <- sampleNames
head(track)
```

## Asignación Taxonómica
Es común en este punto, especialmente en la secuenciación de amplicón 16S/18S/ITS, asignar taxonomía a las variantes de secuencia. El paquete **DADA2** proporciona una implementación nativa del método *clasificador bayesiano* ingenuo para este propósito. La función de `assignTaxonomy` toma como entrada un conjunto de secuencias para clasificar y un conjunto de entrenamiento de secuencias de referencia con taxonomía conocida, y genera asignaciones taxonómicas con al menos `minBoot` bootstrap confianza.
Mantenemos fastas de entrenamiento formateados para el conjunto de entrenamiento RDP, GreenGenes agrupados en un 97 % de identidad y la base de datos de referencia Silva, y se han contribuido fastas de entrenamientos adicionales adecuados para protistas y ciertos entornos específicos. Para la taxonomía fúngica, los archivos de publicación de General Fasta de la base de datos UNITE ITS se pueden usar tal cual. 
Para continuar, descargue el archivo `silva_nr_v138_train_set.fa.gz` y colóquelo en el directorio con los archivos fastq. 
La *tabla de secuencias sin las quimeras*, es la tabla que usamos para realizar la clasificación taxonómica. En principio, podríamos usar cualquiera de las tres bases de datos más populares para clasificación de secuencias del 16S rRNA, i.e., GreenGenes, RDP o SILVA.

### SILVA versión 138.
SILVA proporciona conjuntos de datos completos, de calidad comprobada y actualizados periódicamente de secuencias alineadas de ARN ribosómico (ARNr) pequeñas (16S/18S, SSU) y subunidades grandes (23S/28S, LSU) para los tres dominios de la vida (bacterias, arqueas y eucariotas). 
```{r}
fastaRef <- "//wsl.localhost/Ubuntu/home/davidalbertoge/Metagenomica/16s/silva_nr_v138_train_set.fa"
taxTab <- assignTaxonomy(seqtabNoC, refFasta = fastaRef, multithread=TRUE)
```
El paquete **DADA2** también implementa un método para realizar **asignaciones de nivel de especie** basadas en coincidencias exactas entre ASV y cepas de referencia secuenciadas. Un análisis reciente sugiere que la coincidencia exacta (o el 100 % de identidad) es la única forma adecuada de asignar especies a los fragmentos del gen 16S. Actualmente, los fastas de entrenamiento de asignación de especies están disponibles para las bases de datos **Silva** y **RDP** 16S. Para seguir el paso opcional de adición de especies, descargue el archivo `silva_species_assignment_v138.fa.gz` y colóquelo en el directorio con los archivos fastq. 
```{r}
# En el caso de querer agregar el rango taxonómico de especies, simplemente usamos una base de datos extra, la cual contiene esta información. 
taxTabExtra <- addSpecies(taxTab, "//wsl.localhost/Ubuntu/home/davidalbertoge/Metagenomica/16s/silva_species_assignment_v138.fa", verbose=TRUE)
unname(head(taxTab)) -> tabla
colnames(tabla) <- c("Kingdom", "Phylum", "Order", "Class", "Family", "Genus")
head(tabla)
```

**Alternativas**: El método de clasificación taxonómica `IdTaxa` desarrollado recientemente también está disponible a través del paquete **DECIPHER Bioconductor**. El documento que presenta el algoritmo **IDTAXA** informa un rendimiento de clasificación que es mejor que el estándar establecido durante mucho tiempo por el clasificador bayesiano ingenuo. Aquí incluimos un bloque de código que le permite usar `IdTaxa` como un reemplazo directo para `assignTaxonomy` (¡y también es más rápido!). Los clasificadores capacitados están disponibles en http://DECIPHER.codes/Downloads.html. Descargue el archivo SILVA SSU r132 (modificado) para continuar. 
```{r}
#library(DECIPHER); packageVersion("DECIPHER")
#dna <- DNAStringSet(getSequences(seqtabNoC)) # Crea un DNAStringSet desde el ASVs
#load("~/Documents/calakmul/16S/SILVA_SSU_r138_2019.RData") # Asignamos la dirección de archivo SSU modicado .RData
#ids <- IdTaxa(dna, trainingSet, strand="top", processors=NULL, verbose=FALSE) #  usar todos los procesadores
#ranks <- c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species") # rangos de interés
# Convierta el objeto de salida de la clase "Taxa" en una matriz análoga a la salida de AssignTaxonomy 
#taxid <- t(sapply(ids, function(x) {
#        m <- match(ranks, x$rank)
#        taxa <- x$taxon[m]
#        taxa[startsWith(taxa, "unclassified_")] <- NA
#        taxa
#}))
#colnames(taxid) <- ranks; rownames(taxid) <- getSequences(seqtabNoC)
```
La matriz `taxid` de `IdTaxa` es un reemplazo directo de la matriz `taxa` de `AssignTaxonomy`, simplemente configure `taxa <- taxid` para continuar usando las asignaciones de `IdTaxa`.

## Árbol filogenético
Ya que nuestro perfil taxonómico se construye con secuencias homólogas del 16S rRNA gene, podemos usar estas secuencias para inferir un árbol filogenético. Existen muchos paquetes de r que pueden hacer esto y aquí escogemos phangorn para hacer una inferencia basada en **Maximum Likelihood**.
Primero alineamos las secuencias:
```{r}
seqs <- getSequences(seqtabNoC)
# Este paso propaga los nombres de las secuencias al árbol
names(seqs) <- seqs
alignment <- AlignSeqs(DNAStringSet(seqs), anchor=NA,verbose=FALSE)
```
Y con ese alineamiento inferimos un árbol de partida o starting tree para inicializar la búsqueda por ML. También ajustamos un modelo de sustitución nucleotídica para parametrizar la tasa de cambio de un nucleótido a otro y así poder inferir correctamente el largo de las ramas y la topología del árbol.
```{r}
phangAlign <- phyDat(as(alignment, "matrix"), type="DNA")
dm <- dist.ml(phangAlign)
treeNJ <- NJ(dm) 
fit <- pml(treeNJ, data=phangAlign)
fitGTR <- update(fit, k=4, inv=0.2)
# The option model in pml is only used for amino acid models. 
# fitGTR <- optim.pml(fitGTR, model="GTR", optInv=TRUE, optGamma=TRUE,
#        rearrangement = "stochastic", control = pml.control(trace = 0))
detach("package:phangorn", unload=TRUE)
```

## Metadatos
Ahora, tenemos todos los ingredientes para formar un objeto de R que contenga todo lo que nos importa en un experimento metagenómico, i.e., una tabla de cuentas que indica el número de reads por seceuncia del 16S rRNA gene, una tabla con el linaje taxonómico de esas secuencias, un árbol filogenético que relaciona esas secuencias entre sí, y finalmente, una tabla con variables asociadas a nuestras muestras, también llamada metadata.
```{r}
samdf <- read.csv("//wsl.localhost/Ubuntu/home/davidalbertoge/Metagenomica/16s/Metadata16s.csv", header=TRUE, row.names = 1)
rownames(seqtabNoC) %in% rownames(samdf)
all(rownames(seqtabAll) %in% samdf$run)
```

# Phyloseq
Con estos elementos procedemos a generar un objeto phyloseq:
```{r}
ps <- phyloseq(otu_table(seqtabNoC, taxa_are_rows=FALSE), 
               sample_data(samdf), 
               tax_table(taxTab),
               phy_tree(fitGTR$tree))
ps <- prune_samples(sample_names(ps) != "Mock", ps) # Remover potenciales muestras sintéticas
ps
```

**Phyloseq** es un paquete de Bioconductor (Open Source Software For Bioinformatics) para la manipulación y análisis de datos metagenómicos generados por metodologías de secuenciación de alto rendimiento. **Phyloseq** es una herramienta para importar, guardar, analizar y visualizar éste tipo de datos después de haber sido procesados inicialmente, e.g., ensamblaje de novo, ASVs u OTUs (clustered), incluyendo otros importantes datos asociados (si están disponibles): tabla de observaciones asociadas a cada muestra (e.g., especie, localización geográfica, temperatura, etc.), conocida como sample data o metadata, árbol filogenético, e identificación taxonómica de cada OTU. La estructura del paquete **Phyloseq** consiste en una serie de funciones de acceso y de proceso de objetos phyloseq. Estos objetos están compuestos de cuatro componentes que almacenan las cuentas de reads, la metadata, la taxonomía y el árbol filogenético. El paquete también provee una serie de herramientas para importar datos de otros programas. El siguiente diagrama muestra la estructura completa de phyloseq.
```{r}
# Leémos el objeto phyloseq del análisis por DADA2
ps
class(ps)
```

Es más conveniente usar nombres cortos para nuestros ASV (por ejemplo, ASV21) en lugar de la secuencia de ADN completa cuando se trabaja con algunas de las tablas y visualizaciones de phyloseq, pero queremos mantener las secuencias de ADN completas para otros fines, como fusionar con otros conjuntos de datos. o la indexación en bases de datos de referencia como Earth Microbiome Project. Por esa razón, almacenaremos las secuencias de ADN de nuestros ASV en la ranura refseq del objeto phyloseq y luego cambiaremos el nombre de nuestros taxones a una cadena corta. De esa forma, los nombres breves de los nuevos taxones aparecerán en tablas y gráficos, y aún podemos recuperar las secuencias de ADN correspondientes a cada ASV según sea necesario con refseq(ps). 
```{r}
dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps)))
ps
# Generamos otro archivo con el que empezamos a trabajar
psd <- ps
```

## Control de calidad del análisis de 16S
Lo primero que podemos mirar es la prevalencia de las features taxonómicas.
Primero creamos un data frame con los valores de prevalencia, luego les agregamos la taxonomía y graficamos.
```{r}
# Computamos prevalencia para cada feature y la guardamos en un data frame
prevdf <- apply(X = otu_table(psd),
               MARGIN = ifelse(taxa_are_rows(psd), yes = 1, no = 2),
               FUN = function(x){sum(x > 0)})
# Le agregamos la taxonomía
prevdf <- data.frame(Prevalence = prevdf,
                    TotalAbundance = taxa_sums(psd),
                    tax_table(psd))

plyr::ddply(prevdf, "Phylum", function(df1){cbind(mean(df1$Prevalence),sum(df1$Prevalence))}) -> dfprev
kable(dfprev)
```

Al examinar la tabla, es evidente que algunos Phylum aunque presentes, están muy poco representados. La columna 1 representa la media de read counts para ese Phylum, mientras que la columna 2 representa la suma. Por ejemplo, grupos como Calditrichota y Dadabacteria están representados solamente por 1 read. Es muy riesgoso mantener estos grupos taxonómicos en el análisis ya que pueden corresponder a falsos positivos.
Para filtrarlos, generamos un vector con todas las taxa que queremos filtrar.
```{r}
# Definimos taxa a filtrar
filterPhyla <- c("Calditrichota", "Dadabacteria", NA)
# Procedemos a filtrar
psd1 <- subset_taxa(psd, !Phylum %in% filterPhyla)
```

```{r}
# Además aprovechamos a remover taxa que no corresponde a microorganismos como cloroplastos, mitocondrias y otros
filterPhyla2 <- c("Chloroplast", "Mitochondria", "Eukaryota")
psd1 <- subset_taxa(psd1, !Kingdom %in% filterPhyla2)
psd1 <- subset_taxa(psd1, !Phylum %in% filterPhyla2)
psd1 <- subset_taxa(psd1, !Class %in% filterPhyla2)
psd1 <- subset_taxa(psd1, !Order %in% filterPhyla2)
psd1 <- subset_taxa(psd1, !Family %in% filterPhyla2)
psd1 <- subset_taxa(psd1, !Genus %in% filterPhyla2)
```

Además del filtrado que acabamos de realizar, existen otros tipos de filtrado que tienen que ver con la media de read counts por taxa, con la distribución de éstas, y con filtrar muestras bajo un número mínimo de reads.
```{r}
# Filtramos taxa de acuerdo a un umbral de número medio de _read counts_, en este caso 1e-5
psd2 <- filter_taxa(psd1, function(x) mean(x) > 1e-5, TRUE)
# También podemos remover taxa que no se observe más de X veces en al menos 10% de las muestras
psd3 <- filter_taxa(psd2, function(x) sum(x > 2) > (0.1*length(x)), TRUE)
# Y finalmente filtrar muestras con menos de 1000 reads
psd4 <- prune_samples(sample_sums(psd3) > 1000, psd3)
psd4
```

Otra forma de filtrar taxa de baja prevalencia es estableciendo un umbral y luego visulizar el efecto de manera grafica.
```{r}
# Seleccionamos las taxa de interés
prevdf1 <- subset(prevdf, Phylum %in% get_taxa_unique(psd4, "Phylum"))
ggplot(prevdf1, aes(TotalAbundance, Prevalence / nsamples(psd),color=Phylum)) +
# Agregamos una línea para nuestro umbral
geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) +  geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() +  xlab("Total Abundance") + ylab("Prevalence [Frac. Samples]") +
  facet_wrap(~Phylum) + theme(legend.position="none")
```

```{r}
# Definimos el umbral de prevalencia a un 5%
prevalenceThreshold <- 0.05 * nsamples(psd4)
# Ejecutamos un filtro de prevalencia, usando la función `prune_taxa()`
keepTaxa <- rownames(prevdf1)[(prevdf1$Prevalence >= prevalenceThreshold)]
psd5 <- prune_taxa(keepTaxa, psd4)
```

DADA2 usa como nombre de las taxa la secuencia o ASV asociada a un taxon determinado. Esto es conveniente cuando nos interesa la secuencia en nuestros análisis, sin embargo en este práctico solamente vamos a trabajar a nivel de comunidad.
Por esto, vamos a reemplazar esos nombres con códigos correlativos, lo cual va a hacer las visualizaciones posteriores más entendibles.
```{r}
# Reemplazamos las secuencias por un nombre genérico
taxa_names(psd5) <- paste0("ASV", seq(ntaxa(psd5)))
```

## Distribución
Con nuestro objeto phyloseq ya filtrado y listo para usar, podemos gráficar la distribución de read counts por número de muestra de forma de tener una idea sobre la distribución de éstas.
```{r}
sample_sum_df <- data.frame(sum = sample_sums(psd5))

ggplot(sample_sum_df, aes(x = sum)) + 
  geom_histogram(color = "black", fill = "grey", binwidth = 2500) +
  ggtitle("Distribution of sample sequencing depth") + 
  xlab("Read counts") +
  theme(axis.title.y = element_blank()) 
```

Finalmente, calculamos curvas de rarefacción para cada muestra, de manera tal que podamos determinar si la profundidad de secuenciación fue sufuciente o si tal vez necesitemos secuenciar más. En otras palabras, este análisis nos permitiría averiguar si al secuenciar más observaríamos más OTUs o ASVs.
```{r}
# Primero cargamos algunos scripts de manera remota
scripts <- c("graphical_methods.R",
             "tree_methods.R",
             "plot_merged_trees.R",
             "specificity_methods.R",
             "ternary_plot.R",
             "richness.R",
             "edgePCA.R",
             "copy_number_correction.R",
             "import_frogs.R",
             "prevalence.R",
             "compute_niche.R")
urls <- paste0("https://raw.githubusercontent.com/mahendra-mariadassou/phyloseq-extended/master/R/", scripts)

for (url in urls) {
  source(url)
}
```
Objeto
```{r}
p <- ggrare(psd5, step = 100, label = "SITE_ID", plot = TRUE, parallel = FALSE, se = TRUE, color = "SITE_ID")
```
Gráfica
```{r}
q <- p + theme_classic2()+
  scale_fill_brewer(palette = "Set1")+
  scale_color_brewer(palette = "Set1")
q
pdf("Resultados/PlotDistribution.pdf", width=10, height=7)
q
dev.off()
svg("Resultados/PlotDistribution.svg", width=10, height=7)
q
dev.off()
pdf("Resultados/PlotDistribution1.pdf", width=10, height=7)
q + facet_wrap("SITE_ID")
dev.off()
svg("Resultados/PlotDistribution1.svg", width=10, height=7)
q + facet_wrap("SITE_ID")
dev.off()
```

## Estructura y manipulación de un objeto phyloseq
Muchas veces queremos analizar un sub conjunto de las muestras en nuestro objeto phyloseq, o bien, queremos seleccionar ciertos grupos taxonómicos para análisis posteriores. phyloseq nos permite hacer todo tipo de filtros para llevar esto a cabo. Veamos dónde se almacena la información en phyloseq.
```{r}
ntaxa(psd5)
nsamples(psd5)
sample_names(psd5)
rank_names(psd5)
sample_variables(psd5)
plot_tree(psd5, color = "SITE_ID", ladderize = "left", justify = "jagged", size = "Abundance", method = "treeonly")
```
```{r}
tree <- plot_tree(psd5, color="Phylum", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree
pdf("Resultados/PlotTree.pdf", width=15, height=7)
tree
dev.off()
svg("Resultados/PlotTree.svg", width=15, height=7)
tree
dev.off()
```

Primero la tabla de cuentas.
```{r}
otu_table(psd5)[1:5, 1:5]
```

La tabla de cuentas relaciona el nombre de las taxa con las muestras y con el número de reads mapeadas en contra de ellas. Acá el número de reads es directamente proporcional al número de veces que se observa un taxon.
El otro componente importante es la tabla de taxonomía.
```{r}
tax_table(psd5)[1:5, 1:4]
```

La tabla de taxonomía relaciona el nombre de las taxa con el linaje taxonómico de éstas, i.e., vincula una variante de secuencia, o ASV, con los rangos taxonómicos desde Reino hasta Género o Especie dependiendo del nivel de resolución del análisis.
Veamos ahora el otro componente esencial que es la metadata.

Finalmente, tenemos el árbol filogenético, que es opcional en phyloseq, que nos muestra las relaciones evolutivas entre las taxa de todas las muestras. Es opcional porque normalmente cuando hacemos shotgun metagenomics no contamos con un marcador universal y por lo tanto no hay filogenia.
Podemos graficar simplemente la filogenia con la función plot_tree.
```{r}
# Esta es la filogenia asociada a las taxa en nuestro objeto phyloseq
plot_tree(psd5, method = "treeonly", ladderize = "left")

phy_tree(psd5)
taxa_names(psd5)[1:10]

myTaxa = names(sort(taxa_sums(psd5), decreasing = TRUE)[1:10])
ex1 = prune_taxa(myTaxa, psd5)
plot(phy_tree(ex1), show.node.label = TRUE)
```

Ahora, el objeto phyloseq se ha vuelto un estándar en la industria ya que otros paquetes ahora usan esta estructura de datos para sus propias funciones. Uno de esos paquetes es microbiome y ampvis. Podemos fácilmente obtener un resumen global de nuestro objeto phyloseq usando la función summarize_phyloseq.

```{r}
summarize_phyloseq(psd5)
```
Este comando nos muestra el mínimo y máximo de reads, número total y promedio de reads, etc. También muestra los encabezados de las columans en la tabla de metadata.
Veamos ahora una tabla que mezcle metadata, taxonomía y abundancia del taxon más abundante de cada muestra.
```{r}
df <- psmelt(psd5)
df
```

También es importante tener una visión de cómo se distribuyen las muestras de acuerdo a la metadata. En este ejemplo, graficamos la frecuencia 
```{r}
res <- plot_frequencies(sample_data(psd5), "SITE_ID", "P_OLSEN")
res
```
Ahora veamos cómo podemos filtrar y hacer subsetting de un objeto phyloseq. Esto lo hacemos con tres grupos de funciones, i.e., filter, subset, y prune. Filtrar se refiere a filtrar según alguna regla lógica. Ya lo hicimos en la parte de control de calidad cuando llamamos la función filter_taxa(psd1, function(x) mean(x) > 1e-5, TRUE). Acá le pedíamos a la función filter_taxa que sobre el objeto psd5, calculara la media de read counts para cada taxa y si este resultado era menor que 1e-5, lo eliminara. Veamos un ejemplo diferente y filtremos según abundancia.
Primero transformamos en abundancia relativa y luego filtramos.
```{r}
# Transformamos las cuentas en porcentaje
psd5r <- transform_sample_counts(psd5, function(x) x / sum(x) * 100 )
# Filtramos las taxa con una abundancia inferior al 1%
psd5r.filtrado <- filter_taxa(psd5r, function(x) sum(x) > 1, TRUE)
```

¿Cuántas taxa permanecen en nuestro objeto phyloseq? Con una operación tan simple como la que acabamos de aplicar, nos damos cuenta que la mayoría de las taxa presentes en nuestras muestras están en muy baja abundancia.
Ahora imaginemos la situación donde queremos filtrar nuestro objeto pero en función de un taxon en específico.

```{r}
# Ahora filtramos de acuerdo a Acidobacteriota
subset_taxa(psd5r.filtrado, Phylum == "Acidobacteriota") -> psd5r.filtrado.Acidobacteriota
# También podríamos todo lo que NO es Acidobacteriota
subset_taxa(psd5r.filtrado, Phylum != "Acidobacteriota") -> psd5r.filtrado.NoAcidobacteriota
```

Otra manera de filtrar un objeto phyloseq es en base a algún atributo presente en sample_data. Por ejemplo, con estos datos uno podría querer estudiar el microbioma de área por separado. Para esto crearíamos tres objetos phyloseq a partir de psd5.
```{r}
psd5.Ag1 <- subset_samples(psd5, SITE_ID == "Ag1")
psd5.Ag2 <- subset_samples(psd5, SITE_ID == "Ag2")
psd5.Ag3 <- subset_samples(psd5, SITE_ID == "Ag3")
```

Alternativamente, podríamos decicir estudiar solo dos de las 3 áreas
```{r}
psd5.Ag1_Ag2 <- subset_samples(subset_samples(psd5, SITE_ID != "Ag3"))
```
### Dendograma - Acidobacteriota
El comando `prune_samples()` también es muy usado ya que nos permite usar un vector con las muestras que queremos mantener (similar a `subset_samples`) o un vector lógico donde las muestras que queremos mantener son verdaderas.
```{r}
# Primero seleccionamos solo el Phylum Acidobacteriota
subset_taxa(psd5, Phylum=="Acidobacteriota") -> psd5.Acidobacteriota
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Acidobacteriota de más de 5 reads
prune_samples(sample_sums(psd5.Acidobacteriota)>=5, psd5.Acidobacteriota) -> psd5.Acidobacteriota
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.acido <- plot_tree(psd5.Acidobacteriota, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Acidobacteriota")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.acido
pdf("Resultados/PlotTreeAcido.pdf", width=15, height=7)
tree.acido
dev.off()
svg("Resultados/PlotTreeAcido.svg", width=15, height=7)
tree.acido
dev.off()
```
### Dendograma - Actinobacteriota
```{r}
# Primero seleccionamos solo el Phylum Actinobacteriota
subset_taxa(psd5, Phylum=="Actinobacteriota") -> psd5.Actinobacteriota
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Actinobacteriota de más de 5 reads
prune_samples(sample_sums(psd5.Actinobacteriota)>=5, psd5.Actinobacteriota) -> psd5.Actinobacteriota
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.actino <- plot_tree(psd5.Actinobacteriota, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Actinobacteriota")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.actino
pdf("Resultados/PlotTreeActino.pdf", width=17, height=7)
tree.actino
dev.off()
svg("Resultados/PlotTreeActino.svg", width=17, height=7)
tree.actino
dev.off()
```
### Dendograma - Proteobacteria
```{r}
# Primero seleccionamos solo el Phylum Proteobacteria
subset_taxa(psd5, Phylum=="Proteobacteria") -> psd5.Proteobacteria
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Proteobacteria de más de 5 reads
prune_samples(sample_sums(psd5.Proteobacteria)>=5, psd5.Proteobacteria) -> psd5.Proteobacteria
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.proteo <- plot_tree(psd5.Proteobacteria, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Proteobacteria")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.proteo
pdf("Resultados/PlotTreeProteo.pdf", width=20, height=7)
tree.proteo
dev.off()
svg("Resultados/PlotTreeProteo.svg", width=20, height=7)
tree.proteo
dev.off()
```
### Dendograma - Firmicutes
```{r}
# Primero seleccionamos solo el Phylum Firmicutes
subset_taxa(psd5, Phylum=="Firmicutes") -> psd5.Firmicutes
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Firmicutes de más de 5 reads
prune_samples(sample_sums(psd5.Firmicutes)>=5, psd5.Firmicutes) -> psd5.Firmicutes
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.firmi <- plot_tree(psd5.Firmicutes, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Firmicutes")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.firmi
pdf("Resultados/PlotTreeFirmi.pdf", width=10, height=7)
tree.firmi
dev.off()
svg("Resultados/PlotTreeFirmi.svg", width=10, height=7)
tree.firmi
dev.off()
```
### Dendograma - Bacteroidota
```{r}
# Primero seleccionamos solo el Phylum Bacteroidota
subset_taxa(psd5, Phylum=="Bacteroidota") -> psd5.Bacteroidota
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Bacteroidota de más de 5 reads
prune_samples(sample_sums(psd5.Bacteroidota)>=5, psd5.Bacteroidota) -> psd5.Bacteroidota
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.bacte <- plot_tree(psd5.Bacteroidota, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Bacteroidota")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.bacte
pdf("Resultados/PlotTreeBacte.pdf", width=10, height=7)
tree.bacte
dev.off()
svg("Resultados/PlotTreeBacte.svg", width=10, height=7)
tree.bacte
dev.off()
```
### Dendograma - Chloroflexi
```{r}
# Primero seleccionamos solo el Phylum Chloroflexi
subset_taxa(psd5, Phylum=="Chloroflexi") -> psd5.Chloroflexi
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Chloroflexi de más de 5 reads
prune_samples(sample_sums(psd5.Chloroflexi)>=5, psd5.Chloroflexi) -> psd5.Chloroflexi
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.chloro <- plot_tree(psd5.Chloroflexi, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Chloroflexi")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.chloro
pdf("Resultados/PlotTreeChloro.pdf", width=10, height=7)
tree.chloro
dev.off()
svg("Resultados/PlotTreeChloro.svg", width=10, height=7)
tree.chloro
dev.off()
```
### Dendograma - Desulfobacterota
```{r}
# Primero seleccionamos solo el Phylum Desulfobacterota
subset_taxa(psd5, Phylum=="Desulfobacterota") -> psd5.Desulfobacterota
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Desulfobacterota de más de 5 reads
prune_samples(sample_sums(psd5.Desulfobacterota)>=5, psd5.Desulfobacterota) -> psd5.Desulfobacterota
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.desulf <- plot_tree(psd5.Desulfobacterota, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Desulfobacterota")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.desulf
pdf("Resultados/PlotTreeDesulf.pdf", width=10, height=7)
tree.desulf
dev.off()
svg("Resultados/PlotTreeDesulf.svg", width=10, height=7)
tree.desulf
dev.off()
```
### Dendograma - Gemmatimonadota
```{r}
# Primero seleccionamos solo el Phylum Gemmatimonadota
subset_taxa(psd5, Phylum=="Gemmatimonadota") -> psd5.Gemmatimonadota
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Gemmatimonadota de más de 5 reads
prune_samples(sample_sums(psd5.Gemmatimonadota)>=5, psd5.Gemmatimonadota) -> psd5.Gemmatimonadota
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.gemma <- plot_tree(psd5.Gemmatimonadota, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Gemmatimonadota")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.gemma
pdf("Resultados/PlotTreeGemma.pdf", width=10, height=7)
tree.gemma
dev.off()
svg("Resultados/PlotTreeGemma.svg", width=10, height=7)
tree.gemma
dev.off()
```
### Dendograma - Myxococcota
```{r}
# Primero seleccionamos solo el Phylum Myxococcota
subset_taxa(psd5, Phylum=="Myxococcota") -> psd5.Myxococcota
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Myxococcota de más de 5 reads
prune_samples(sample_sums(psd5.Myxococcota)>=5, psd5.Myxococcota) -> psd5.Myxococcota
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.myxo <- plot_tree(psd5.Myxococcota, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Myxococcota")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.myxo
pdf("Resultados/PlotTreeMyxo.pdf", width=10, height=7)
tree.myxo
dev.off()
svg("Resultados/PlotTreeMyxo.svg", width=10, height=7)
tree.myxo
dev.off()
```
### Dendograma - Planctomycetota
```{r}
# Primero seleccionamos solo el Phylum Planctomycetota
subset_taxa(psd5, Phylum=="Planctomycetota") -> psd5.Planctomycetota
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Planctomycetota de más de 5 reads
prune_samples(sample_sums(psd5.Planctomycetota)>=5, psd5.Planctomycetota) -> psd5.Planctomycetota
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.planc <- plot_tree(psd5.Planctomycetota, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Planctomycetota")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.planc
pdf("Resultados/PlotTreePlanc.pdf", width=10, height=7)
tree.planc
dev.off()
svg("Resultados/PlotTreePlanc.svg", width=10, height=7)
tree.planc
dev.off()
```
### Dendograma - Verrucomicrobiota
```{r}
# Primero seleccionamos solo el Phylum Verrucomicrobiota
subset_taxa(psd5, Phylum=="Verrucomicrobiota") -> psd5.Verrucomicrobiota
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Verrucomicrobiota de más de 5 reads
prune_samples(sample_sums(psd5.Verrucomicrobiota)>=5, psd5.Verrucomicrobiota) -> psd5.Verrucomicrobiota
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.verru <- plot_tree(psd5.Verrucomicrobiota, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Verrucomicrobiota")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.verru
pdf("Resultados/PlotTreeVerru.pdf", width=10, height=7)
tree.verru
dev.off()
svg("Resultados/PlotTreeVerru.svg", width=10, height=7)
tree.verru
dev.off()
```

### Dendograma - Halobacterota
```{r}
# Primero seleccionamos solo el Phylum Halobacterota
subset_taxa(psd5, Phylum=="Halobacterota") -> psd5.Halobacterota
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Halobacterota de más de 5 reads
prune_samples(sample_sums(psd5.Halobacterota)>=5, psd5.Halobacterota) -> psd5.Halobacterota
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.halo <- plot_tree(psd5.Halobacterota, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Halobacterota")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.halo
pdf("Resultados/PlotTreeHalo.pdf", width=10, height=7)
tree.halo
dev.off()
svg("Resultados/PlotTreeHalo.svg", width=10, height=7)
tree.halo
dev.off()
```

### Dendograma - Euryarchaeota
```{r}
# Primero seleccionamos solo el Phylum Euryarchaeota
subset_taxa(psd5, Phylum=="Euryarchaeota") -> psd5.Euryarchaeota
# Luego nos quedamos con las muestras que solo cumplen con la condición, i,e, que poseen una abundancia de Euryarchaeota de más de 5 reads
prune_samples(sample_sums(psd5.Euryarchaeota)>=5, psd5.Euryarchaeota) -> psd5.Euryarchaeota
# Y finalmente visualizamos los resultados mapeados en el árbol filogenético
tree.eury <- plot_tree(psd5.Euryarchaeota, color="Genus", size = "abundance", base.spacing = 0.03) +
  facet_wrap("SITE_ID")+ 
  theme_classic()+ 
  labs(x="Sample", y="OTUs",
       title="Phylogenetic tree of the phylum Euryarchaeota")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
tree.eury
pdf("Resultados/PlotTreeEury.pdf", width=10, height=7)
tree.eury
dev.off()
svg("Resultados/PlotTreeEury.svg", width=10, height=7)
tree.eury
dev.off()
```

Para finalizar esta sección, un par de funciones muy útiles en phyloseq son `tax_glom()` y `tip_glom()`. Ambas funciones tratan de agrupar o aglomerar un objeto de acuerdo a alguna propiedad, de esta manera simplificándolo. Por ejemplo, es muy probable que uno tenga varias ASVs del mismo género ya que si bien a nivel de secuencia son diferentes, estas corresponden al mismo género.
Para hacer visualizaciones y otros análisis puede ser conveniente colapsar o aglomerar estas secuencias del mismo género u otro rango taxonómico. Al mismo tiempo, `tip_glom()` realiza una función similar pero basándose en una “altura” arbitraria en el árbol filogenético.
```{r}
# Primero aglomeramos por género
psd5.genus = tax_glom(psd5, "Genus", NArm = FALSE)
# Luego por altura en el árbol filogenético
h1 = 0.4
psd5.tip = tip_glom(psd5, h = h1)
# Grafiquemos una comparación para visualizar las diferencias
multiPlotTitleTextSize = 15
p2tree = plot_tree(psd5, method = "treeonly",
                   ladderize = "left",
                   title = "Sin aglomeración") +
  theme(plot.title = element_text(size = multiPlotTitleTextSize))
p3tree = plot_tree(psd5.genus, method = "treeonly",
                   ladderize = "left", title = "A nivel de género") +
  theme(plot.title = element_text(size = multiPlotTitleTextSize))
p4tree = plot_tree(psd5.tip, method = "treeonly",
                   ladderize = "left", title = "Por altura") +
  theme(plot.title = element_text(size = multiPlotTitleTextSize))

# Graficamos los árboles juntos
grid.arrange(nrow = 1, p2tree, p3tree, p4tree)
```

## Ensamble y manipulación de objetos de **Phyloseq** con una miríada de muestras
```{r}
psd5
sample_sums(x = psd5)
summary(psd5@otu_table@.Data)
```
Graficamos con ggplot2
```{r}
#Generamos un data.frame con datos del merge_metagenomes
deep <- data.frame(Samples = psd5@sam_data@.Data[[1]],
                   Reads = sample_sums(psd5))
deep
#Graficamos
plot.reads <- ggplot(data = deep, mapping = aes(x = Samples, y = Reads, fill = Samples)) +
  theme_classic() +
  labs(x="Samples", y="Reads",
       title = "Total readings of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  geom_col(position = position_dodge(0.9), width = 0.9) +
  scale_fill_brewer(palette = "Paired")
plot.reads
pdf("Resultados/PlotReads.pdf", width=10, height=7)
plot.reads
dev.off()
svg("Resultados/PlotReads.svg", width=10, height=7)
plot.reads
dev.off()
```

## Transformación y manipulación de datos
```{r}
#Con esto nos dice cuántos datos vacios hay, en este caso serán todos aquellos que aparezcan como TRUE
summary(psd5@tax_table@.Data== "")
#Actualizamos la variable psd5 indicando que se incluya todo lo diferente (!=) a vacio "", para la variable "Genus"
psd5 <- subset_taxa(psd5, Genus != "")
summary(psd5@tax_table@.Data== "")
```

Conversión de valores absolutos a relativos
```{r}
head(psd5@otu_table@.Data) 
# Porcentaje serán valores relativos
percentages  = transform_sample_counts(psd5, function(x) x*100 / sum(x) )
head(percentages@otu_table@.Data)
```

Nos quedamos solo con "Phylum"
```{r}
glom <- tax_glom(percentages, taxrank = 'Phylum')
# View(glom@tax_table@.Data)
# psmelt permite generar un data.frame a partir de un objeto de phyloseq
# Valores relativos
percentages <- psmelt(glom)
str(percentages)
# Valores absolutos
raw <- tax_glom(physeq = psd5, taxrank = "Phylum")
raw.data <- psmelt(raw)
str(raw.data)
```

Graficamos comparando valores absolutos vs valores relativos
```{r}
raw.plot <- ggplot(data=raw.data, aes(x=SITE_ID, y=Abundance, fill=Phylum)) + 
  geom_bar(aes(), stat="identity", position="stack") + 
  theme_classic() +
  labs(x="Samples", y="Absolute abundance",
       title = "Absolute abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))

rel.plot <- ggplot(data=percentages, aes(x=SITE_ID, y=Abundance, fill=Phylum)) + 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme_classic() +
  labs(x="Samples", y="Relative abundance",
       title = "Relative abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))

raw.plot | rel.plot

pdf("Resultados/PlotRaw.pdf", width=10, height=7)
raw.plot
dev.off()
svg("Resultados/PlotRaw.svg", width=10, height=7)
raw.plot
dev.off()
pdf("Resultados/PlotRel.pdf", width=10, height=7)
rel.plot
dev.off()
svg("Resultados/PlotRel.svg", width=10, height=7)
rel.plot
dev.off()
pdf("Resultados/PlotRaw-Rel.pdf", width=15, height=7)
raw.plot | rel.plot
dev.off()
svg("Resultados/PlotRaw-Rel.svg", width=15, height=7)
raw.plot | rel.plot
dev.off()
```

Graficamos comparando valores absolutos vs valores relativos VERSION 2
```{r}
raw.plot1 <- ggplot(data=raw.data, aes(x=ID, y=Abundance, fill=Phylum))+ 
  geom_bar(aes(), stat="identity", position="stack") + 
  theme_classic() +
  labs(x="Samples", y="Absolute abundance",
       title = "Absolute abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))

rel.plot1 <- ggplot(data=percentages, aes(x=ID, y=Abundance, fill=Phylum))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme_classic() +
  labs(x="Samples", y="Relative abundance",
       title = "Relative abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))

raw.plot1 | rel.plot1

pdf("Resultados/PlotRaw1.pdf", width=10, height=7)
raw.plot1
dev.off()
svg("Resultados/PlotRaw1.svg", width=10, height=7)
raw.plot1
dev.off()
pdf("Resultados/PlotRel1.pdf", width=10, height=7)
rel.plot1
dev.off()
svg("Resultados/PlotRel1.svg", width=10, height=7)
rel.plot
dev.off()
pdf("Resultados/PlotRaw-Rel1.pdf", width=15, height=7)
raw.plot1 | rel.plot1
dev.off()
svg("Resultados/PlotRaw-Rel1.svg", width=15, height=7)
raw.plot1 | rel.plot1
dev.off()
```

Reacomodamos para que aquellos phylum con abundancia menor a 1.0 se agrupen.
```{r}
percentages$Phylum <- as.character(percentages$Phylum)
percentages$Phylum[percentages$Abundance < 1.0] <- "Phyla < 1.0% abund."
unique(percentages$Phylum)
```
Con el filtro anterior
```{r}
rel.plot2 <- ggplot(data=percentages, aes(x=SITE_ID, y=Abundance, fill=Phylum))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme_classic() +
  labs(x="Samples", y="Relative abundance",
       title = "Relative abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))

pdf("Resultados/PlotRel2.pdf", width=10, height=7)
rel.plot2
dev.off()
svg("Resultados/PlotRel2.svg", width=10, height=7)
rel.plot2
dev.off()
pdf("Resultados/PlotRaw-Rel2.pdf", width=15, height=7)
raw.plot | rel.plot2
dev.off()
svg("Resultados/PlotRaw-Rel2.svg", width=15, height=7)
raw.plot | rel.plot2
dev.off()

raw.plot | rel.plot2
```
Con el filtro anterior VERSION2
```{r}
rel.plot3 <- ggplot(data=percentages, aes(x=ID, y=Abundance, fill=Phylum))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme_classic() +
  labs(x="Samples", y="Relative abundance",
       title = "Relative abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))

pdf("Resultados/PlotRel3.pdf", width=10, height=7)
rel.plot3
dev.off()
svg("Resultados/PlotRel3.svg", width=10, height=7)
rel.plot3
dev.off()
pdf("Resultados/PlotRaw-Rel3.pdf", width=15, height=7)
raw.plot1 | rel.plot3
dev.off()
svg("Resultados/PlotRaw-Rel3.svg", width=15, height=7)
raw.plot1 | rel.plot3
dev.off()

raw.plot1 | rel.plot3
```

### Distribución - Acidobacteriota
```{r}
psd5 <- subset_taxa(psd5, Kingdom == "Bacteria")
acido <- subset_taxa(psd5, Phylum == "Acidobacteriota")
unique(acido@tax_table@.Data[,2])
acido = transform_sample_counts(acido, function(x) x*100 / sum(x) )
glom <- tax_glom(acido, taxrank = "Genus")
g.acido <- psmelt(glom)
g.acido$Genus[g.acido$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.acido <- ggplot(data=g.acido, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Acidobacteriota")
p.acido
pdf("Resultados/PlotAcido.pdf", width=10, height=7)
p.acido
dev.off()
svg("Resultados/PlotAcido.svg", width=10, height=7)
p.acido
dev.off()
#VERSION2
p.acido1 <- ggplot(data=g.acido, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Acidobacteriota")
p.acido1
pdf("Resultados/PlotAcido1.pdf", width=10, height=7)
p.acido1
dev.off()
svg("Resultados/PlotAcido1.svg", width=10, height=7)
p.acido1
dev.off()
```

### Distribución - Actinobacteria
```{r}
psd5 <- subset_taxa(psd5, Kingdom == "Bacteria")
actino <- subset_taxa(psd5, Phylum == "Actinobacteriota")
unique(actino@tax_table@.Data[,2])
actino = transform_sample_counts(actino, function(x) x*100 / sum(x) )
glom <- tax_glom(actino, taxrank = "Genus")
g.actino <- psmelt(glom)
g.actino$Genus[g.actino$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.actino <- ggplot(data=g.actino, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Actinobacteriota")
p.actino
pdf("Resultados/PlotActino.pdf", width=10, height=7)
p.actino
dev.off()
svg("Resultados/PlotActino.svg", width=10, height=7)
p.actino
dev.off()
#VERSION2
p.actino1 <- ggplot(data=g.actino, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Actinobacteriota")
p.actino1
pdf("Resultados/PlotActino1.pdf", width=10, height=7)
p.actino1
dev.off()
svg("Resultados/PlotActino1.svg", width=10, height=7)
p.actino1
dev.off()
```
### Distribución - Bacteroidota
```{r}
psd5 <- subset_taxa(psd5, Kingdom == "Bacteria")
bacte <- subset_taxa(psd5, Phylum == "Bacteroidota")
unique(bacte@tax_table@.Data[,2])
bacte = transform_sample_counts(bacte, function(x) x*100 / sum(x) )
glom <- tax_glom(bacte, taxrank = "Genus")
g.bacte <- psmelt(glom)
g.bacte$Genus[g.bacte$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.bacte <- ggplot(data=g.bacte, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Bacteroidota")
p.bacte
pdf("Resultados/PlotBacte.pdf", width=10, height=7)
p.bacte
dev.off()
svg("Resultados/PlotBacte.svg", width=10, height=7)
p.bacte
dev.off()
#VERSION2
p.bacte1 <- ggplot(data=g.bacte, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Bacteroidota")
p.bacte1
pdf("Resultados/PlotBacte1.pdf", width=10, height=7)
p.bacte1
dev.off()
svg("Resultados/PlotBacte1.svg", width=10, height=7)
p.bacte1
dev.off()
```
### Distribución - Chloroflexi
```{r}
psd5 <- subset_taxa(psd5, Kingdom == "Bacteria")
chlor <- subset_taxa(psd5, Phylum == "Chloroflexi")
unique(chlor@tax_table@.Data[,2])
chlor = transform_sample_counts(chlor, function(x) x*100 / sum(x) )
glom <- tax_glom(chlor, taxrank = "Genus")
g.chlor <- psmelt(glom)
g.chlor$Genus[g.chlor$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.chlor <- ggplot(data=g.chlor, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Chloroflexi")
p.chlor
pdf("Resultados/PlotChlor.pdf", width=10, height=7)
p.chlor
dev.off()
svg("Resultados/PlotChlor.svg", width=10, height=7)
p.chlor
dev.off()
#VERSION2
p.chlor1 <- ggplot(data=g.chlor, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Chloroflexi")
p.chlor1
pdf("Resultados/PlotChlor1.pdf", width=10, height=7)
p.chlor1
dev.off()
svg("Resultados/PlotChlor1.svg", width=10, height=7)
p.chlor1
dev.off()
```
### Distribución - Desulfobacterota
```{r}
psd5 <- subset_taxa(psd5, Kingdom == "Bacteria")
desul <- subset_taxa(psd5, Phylum == "Desulfobacterota")
unique(desul@tax_table@.Data[,2])
desul = transform_sample_counts(desul, function(x) x*100 / sum(x) )
glom <- tax_glom(desul, taxrank = "Genus")
g.desul <- psmelt(glom)
g.desul$Genus[g.desul$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.desul <- ggplot(data=g.desul, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Desulfobacterota")
p.desul
pdf("Resultados/PlotDesul.pdf", width=10, height=7)
p.desul
dev.off()
svg("Resultados/PlotDesul.svg", width=10, height=7)
p.desul
dev.off()
#VERSION2
p.desul1 <- ggplot(data=g.desul, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Desulfobacterota")
p.desul1
pdf("Resultados/PlotDesul1.pdf", width=10, height=7)
p.desul1
dev.off()
svg("Resultados/PlotDesul1.svg", width=10, height=7)
p.desul1
dev.off()
```
### Distribución - Firmicutes
```{r}
psd5 <- subset_taxa(psd5, Kingdom == "Bacteria")
firmi <- subset_taxa(psd5, Phylum == "Firmicutes")
unique(firmi@tax_table@.Data[,2])
firmi = transform_sample_counts(firmi, function(x) x*100 / sum(x) )
glom <- tax_glom(firmi, taxrank = "Genus")
g.firmi <- psmelt(glom)
g.firmi$Genus[g.firmi$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.firmi <- ggplot(data=g.firmi, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Firmicutes")
p.firmi
pdf("Resultados/PlotFirmi.pdf", width=10, height=7)
p.firmi
dev.off()
svg("Resultados/PlotFirmi.svg", width=10, height=7)
p.firmi
dev.off()
#VERSION2
p.firmi1 <- ggplot(data=g.firmi, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Firmicutes")
p.firmi1
pdf("Resultados/PlotFirmi1.pdf", width=10, height=7)
p.firmi1
dev.off()
svg("Resultados/PlotFirmi1.svg", width=10, height=7)
p.firmi1
dev.off()
```
### Distribución - Gemmatimonadota
```{r}
psd5 <- subset_taxa(psd5, Kingdom == "Bacteria")
gemma <- subset_taxa(psd5, Phylum == "Gemmatimonadota")
unique(gemma@tax_table@.Data[,2])
gemma = transform_sample_counts(gemma, function(x) x*100 / sum(x) )
glom <- tax_glom(gemma, taxrank = "Genus")
g.gemma <- psmelt(glom)
g.gemma$Genus[g.gemma$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.gemma <- ggplot(data=g.gemma, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Gemmatimonadota")
p.gemma
pdf("Resultados/PlotGemma.pdf", width=10, height=7)
p.gemma
dev.off()
svg("Resultados/PlotGemma.svg", width=10, height=7)
p.gemma
dev.off()
#VERSION2
p.gemma1 <- ggplot(data=g.gemma, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Gemmatimonadota")
p.gemma1
pdf("Resultados/PlotGemma1.pdf", width=10, height=7)
p.gemma1
dev.off()
svg("Resultados/PlotGemma1.svg", width=10, height=7)
p.gemma1
dev.off()
```
### Distribución - Myxococcota
```{r}
psd5 <- subset_taxa(psd5, Kingdom == "Bacteria")
myxo <- subset_taxa(psd5, Phylum == "Myxococcota")
unique(myxo@tax_table@.Data[,2])
myxo = transform_sample_counts(myxo, function(x) x*100 / sum(x) )
glom <- tax_glom(myxo, taxrank = "Genus")
g.myxo <- psmelt(glom)
g.myxo$Genus[g.myxo$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.myxo <- ggplot(data=g.myxo, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Myxococcota")
p.myxo
pdf("Resultados/PlotMyxo.pdf", width=10, height=7)
p.myxo
dev.off()
svg("Resultados/PlotMyxo.svg", width=10, height=7)
p.myxo
dev.off()
#VERSION2
p.myxo1 <- ggplot(data=g.myxo, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Myxococcota")
p.myxo1
pdf("Resultados/PlotMyxo1.pdf", width=10, height=7)
p.myxo1
dev.off()
svg("Resultados/PlotMyxo1.svg", width=10, height=7)
p.myxo1
dev.off()
```
### Distribución - Planctomycetota
```{r}
psd5 <- subset_taxa(psd5, Kingdom == "Bacteria")
planc <- subset_taxa(psd5, Phylum == "Planctomycetota")
unique(planc@tax_table@.Data[,2])
planc = transform_sample_counts(planc, function(x) x*100 / sum(x) )
glom <- tax_glom(planc, taxrank = "Genus")
g.planc <- psmelt(glom)
g.planc$Genus[g.planc$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.planc <- ggplot(data=g.planc, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Planctomycetota")
p.planc
pdf("Resultados/PlotPlanc.pdf", width=10, height=7)
p.planc
dev.off()
svg("Resultados/PlotPlanc.svg", width=10, height=7)
p.planc
dev.off()
#VERSION2
p.planc1 <- ggplot(data=g.planc, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Planctomycetota")
p.planc1
pdf("Resultados/PlotPlanc1.pdf", width=10, height=7)
p.planc1
dev.off()
svg("Resultados/PlotPlanc1.svg", width=10, height=7)
p.planc1
dev.off()
```
### Distribución - Proteobacteria
```{r}
psd5 <- subset_taxa(psd5, Kingdom == "Bacteria")
proteo <- subset_taxa(psd5, Phylum == "Proteobacteria")
unique(proteo@tax_table@.Data[,2])
proteo = transform_sample_counts(proteo, function(x) x*100 / sum(x) )
glom <- tax_glom(proteo, taxrank = "Genus")
g.proteo <- psmelt(glom)
g.proteo$Genus[g.proteo$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.proteo <- ggplot(data=g.proteo, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Proteobacteria")
p.proteo
pdf("Resultados/PlotProteo.pdf", width=10, height=7)
p.proteo
dev.off()
svg("Resultados/PlotProteo.svg", width=10, height=7)
p.proteo
dev.off()
#VERSION2
p.proteo1 <- ggplot(data=g.proteo, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Proteobacteria")
p.proteo1
pdf("Resultados/PlotProteo1.pdf", width=10, height=7)
p.proteo1
dev.off()
svg("Resultados/PlotProteo1.svg", width=10, height=7)
p.proteo1
dev.off()
```
### Distribución - Verrucomicrobiota
```{r}
psd5 <- subset_taxa(psd5, Kingdom == "Bacteria")
verru <- subset_taxa(psd5, Phylum == "Verrucomicrobiota")
unique(verru@tax_table@.Data[,2])
verru = transform_sample_counts(verru, function(x) x*100 / sum(x) )
glom <- tax_glom(verru, taxrank = "Genus")
g.verru <- psmelt(glom)
g.verru$Genus[g.verru$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.verru <- ggplot(data=g.verru, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Verrucomicrobiota")
p.verru
pdf("Resultados/PlotVerru.pdf", width=10, height=7)
p.verru
dev.off()
svg("Resultados/PlotVerru.svg", width=10, height=7)
p.verru
dev.off()
#VERSION2
p.verru1 <- ggplot(data=g.verru, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Verrucomicrobiota")
p.verru1
pdf("Resultados/PlotVerru1.pdf", width=10, height=7)
p.verru1
dev.off()
svg("Resultados/PlotVerru1.svg", width=10, height=7)
p.verru1
dev.off()
```
### Distribución - Halobacteriota
```{r}
unique(psd5.Halobacterota@tax_table@.Data[,2])
halo = transform_sample_counts(psd5.Halobacterota, function(x) x*100 / sum(x) )
glom <- tax_glom(halo, taxrank = "Genus")
g.halo <- psmelt(glom)
g.halo$Genus[g.halo$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.halo <- ggplot(data=g.halo, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Halobacterota")
p.halo
pdf("Resultados/PlotHalo.pdf", width=10, height=7)
p.halo
dev.off()
svg("Resultados/PlotHalo.svg", width=10, height=7)
p.halo
dev.off()
#VERSION2
p.halo1 <- ggplot(data=g.halo, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Halobacterota")
p.halo1
pdf("Resultados/PlotHalo1.pdf", width=10, height=7)
p.halo1
dev.off()
svg("Resultados/PlotHalo1.svg", width=10, height=7)
p.halo1
dev.off()
```
### Distribución - Euryarchaeota
```{r}
unique(psd5.Euryarchaeota@tax_table@.Data[,2])
eury = transform_sample_counts(psd5.Euryarchaeota, function(x) x*100 / sum(x) )
glom <- tax_glom(eury, taxrank = "Genus")
g.eury <- psmelt(glom)
g.eury$Genus[g.eury$Abundance < 1.0] <- "Genus < 1.0% abundance"
p.eury <- ggplot(data=g.eury, aes(x=SITE_ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Euryarchaeota")
p.eury
pdf("Resultados/PlotEury.pdf", width=10, height=7)
p.eury
dev.off()
svg("Resultados/PlotEury.svg", width=10, height=7)
p.eury
dev.off()
#VERSION2
p.eury1 <- ggplot(data=g.eury, aes(x=ID, y=Abundance, fill=Genus))+ 
  geom_bar(aes(), stat="identity", position="fill") + 
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  labs(x="Samples", y="Relative abundance",
       title="Abundancia relativa dentro del phylum Euryarchaeota")
p.eury1
pdf("Resultados/PlotEury1.pdf", width=10, height=7)
p.eury1
dev.off()
svg("Resultados/PlotEury1.svg", width=10, height=7)
p.eury1
dev.off()
```

# Análisis de diversidad
¿Qué entendemos por diversidad? Al menos podemos conceptualizar diversidad a dos niveles: diversidad genética o morfológica, y biodiversidad. En el estudio de comunidades, tomamos prestado el concepto de biodiversidad de ecología de comunidades donde estamos interesados en la riqueza de especies (número de especies diferentes en una comunidad o diversidad alfa), en las diferencias y similitudes entre comunidades (diversidad beta), y en algunos casos en la diversidad total de un región o paisaje ecológico (landscape; diversidad gama).
Medidas de riqueza, uniformidad, dominancia, diversidad filogenética (diversidad alfa)

## Alfa diversidad
En el contexto metagenómico, medimos diversidad alfa usando una serie de medidas prestadas de ecología que nos permiten caracterizar una comunidad microbiana. phyloseq tiene una función muy útil que nos permite calcular y graficar hasta siete medidas, i .e., Observed (simplemente el número de taxa o riqueza), Chao1 (la riqueza ajustada por probabilidad de no observar especies), ACE (riqueza que toma en cuenta la abundancia relativa), Shannon (abundancia relativa de taxa), Simpson (1 - la probabilidad de que observemos aleatoriamente dos bacterias en una comunidad y que pertenezcan a diferentes especies ), Inverse Simpson ( 1 / Simpson), y Fisher (riqueza tomando en cuenta abundancia).
En phyloseq simplemente llamamos la función plot_richness y podemos visualizar las medidas de diversidad.
```{r}
psd5 <- prune_taxa(keepTaxa, psd4)
alfa.diver <- plot_richness(physeq = psd5, 
              color =  "SITE_ID",
              x = "SITE_ID",
              measures = c("Observed", "Chao1", "ACE", "Shannon", "Simpson", "Fisher"),
              title = "Alpha diversity indices for the Calakmul samples obtained by rRNA 16s") + 
  labs(x="Samples", y="Alpha Diversity Measure") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  geom_boxplot(aes(fill = SITE_ID), alpha=.7) + 
  scale_color_brewer(palette = "Set1") + 
  scale_fill_brewer(palette = "Set1")
alfa.diver
pdf("Resultados/PlotAlfa.pdf", width=10, height=7)
alfa.diver
dev.off()
svg("Resultados/PlotAlfa.svg", width=10, height=7)
alfa.diver
dev.off()
```

¿Hay un efecto significativo de la diversidad alfa según el área? Eso lo podríamos probar rápidamente con un análisis de varianza (ANOVA). Para este ejemplo utilicemos otra medida de diversidad, una que phyloseq no incorpora. Faith’s Phylogenetic Diversity es un índice introducido por Daniel Faith en 1992 que no solo considera número de especies sino que también considera qué tanto se parecen estas especies filogenéticamente. Esto es muy relevante porque nos entrega una medida rápida para evaluar prioridades de conservación de ecosistemas, o si se trata de comunidades microbianas, donde tenemos mayor probabilidad de encontrar funciones génicas novedosas.

```{r}
# Guardamos un dataframe con las medidas de diversidad alfa
alpha_pd <- estimate_pd(psd5)
# Combinamos la metadata con alpha.diversity
data <- cbind(sample_data(psd5), alpha_pd) 
# Y calculamos un ANOVA
psd5.anova <- aov(PD ~ SITE_ID, data) 
# install.packages("xtable")
psd5.anova.table <- xtable(psd5.anova)
```

El paquete microbiome ofrece otras herramientas para evaluar diversidad que son accesibles fácilmente a través de su función global.
```{r}
tab <- global(psd5, index = "all")
head(tab)
```

La función global nos da 26 medidas de diversidad que nos ayudan a entender la estructura de las comunidades microbianas. En general, estas medidas se dividen en riqueza, diversidad, dominancia, rareza, cobertura y uniformidad.
El paquete microbiome ofrece funciones para calcular cada uno de estos aspectos de las comunidades microbianas.
```{r}
# Riqueza
tab <- richness(psd5)
# Dominancia
tab <- dominance(psd5, index = "all")
# Rareza
tab <- rarity(psd5, index = "all")
# Cobertura
tab <- coverage(psd5, threshold = 0.5)
# Desigualdad
tab <- inequality(psd5)
# Uniformidad
tab <- evenness(psd5, "all")
```

Veamos un ejemplo concreto estimando diversidad, graficando los resultados y calculando significancia estadística. Para esto usamos el paquete ggpubr que genera “publication-ready plots”, algo que siempre es deseable (ejecuta library(ggpubr)).
```{r}
# Generamos un objeto `phyloseq` sin taxa que sume 0 reads
psd5.2 <- prune_taxa(taxa_sums(psd5) > 0, psd5)
# Calculamos los índices de diversidad
tab <- diversities(psd5.2, index = "all")
# Y finalmente visualizamos la tabla de resultados
head(tab)
```

Ahora necesitamos extraer la metadata de nuestro objeto phyloseq.
```{r}
psd5.2.meta <- meta(psd5.2)
head(psd5.2.meta)
```

Luego agregamos la tabla de diversidad a la metadata
```{r}
names(tab)
psd5.2.meta$Shannon <- tab$diversity_shannon 
psd5.2.meta$InverseSimpson <- tab$diversity_inverse_simpson
psd5.2.meta$Chao1 <- tab$chao1
psd5.2.meta$Observed <- tab$observed
psd5.2.meta$Fisher <- tab$diversity_fisher
```
En este ejercicio nos interesa comparar la diversidad entre áreas. Recordemos que tenemos datos para tres áreas: Ag1, Ag2, Ag3. Necesitamos crear una lista de comparasiones de a pares para poder visualizar y calcular significancia estadística de manera simultánea.
```{r}
# Obtenemos las variables desde nuestro objeto `phyloseq`
spps <- levels(as.factor(psd5.2.meta$SITE_ID))
# Creamos una lista de lo que queremos comparar
pares.spps <- combn(seq_along(spps), 2, simplify = FALSE, FUN = function(i) spps[i])
# Imprimimos en pantalla el resultado
print(pares.spps)
```
Con la función ggviolin podemos generar un gráfico de violín en un solo paso de la siguiente forma.
```{r}
# Cargamos una variable de color
COLOR = c("#a6cee3", "#b2df8a", "#fdbf6f")
##
p1 <- ggviolin(psd5.2.meta, x = "SITE_ID", y = "Shannon",
 add = "boxplot", fill = "SITE_ID", palette = COLOR)  
print(p1)
p2 <- ggviolin(psd5.2.meta, x = "SITE_ID", y = "InverseSimpson",
 add = "boxplot", fill = "SITE_ID", palette = COLOR)  
print(p2)
p3 <- ggviolin(psd5.2.meta, x = "SITE_ID", y = "Chao1",
 add = "boxplot", fill = "SITE_ID", palette = COLOR)  
print(p3)
p4 <- ggviolin(psd5.2.meta, x = "SITE_ID", y = "Observed",
 add = "boxplot", fill = "SITE_ID", palette = COLOR)  
print(p4)
p5 <- ggviolin(psd5.2.meta, x = "SITE_ID", y = "Fisher",
 add = "boxplot", fill = "SITE_ID", palette = COLOR)  
print(p5)
```

Ahora necesitamos evaluar la significancia estadística entre los estimados de diversidad de las muestras de ballenas. De nuevo, en una línea, tenemos nuestra figura lista para el artículo.
```{r}
p1 <- p1 + stat_compare_means(comparisons = pares.spps)
print(p1)
p2 <- p2 + stat_compare_means(comparisons = pares.spps)
print(p2)
p3 <- p3 + stat_compare_means(comparisons = pares.spps)
print(p3)
p4 <- p4 + stat_compare_means(comparisons = pares.spps)
print(p4)
p5 <- p5 + stat_compare_means(comparisons = pares.spps)
print(p5)
```
## Beta Diversidad
```{r}
# Con esto vemos todos los métodos (métricas de distancia) para calcular la beta diversidad
distanceMethodList

# Usamos NMDS para disimilitud por pares entre objetos y la métrica de distancia es "bray"
psd5.ord <- ordinate(physeq = psd5, method = "NMDS", distance = "bray")
beta.NMDS <- plot_ordination(physeq = psd5, ordination = psd5.ord, color = "SITE_ID") +
  theme_classic() +
  geom_point(size = 5) +
  geom_text(mapping = aes(label = SITE_ID), size = 4, vjust = 2, hjust = 1) + 
  geom_vline(xintercept = 0)+
  geom_hline(yintercept = 0)+
  labs(title="Beta diversity with NMDS-Bray for the Calakmul samples obtained by rRNA 16s")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  scale_color_brewer(palette = "Set1") + 
  scale_fill_brewer(palette = "Set1")
beta.NMDS
pdf("Resultados/PlotBetaNMDS.pdf", width=10, height=7)
beta.NMDS 
dev.off()
svg("Resultados/PlotBetaNMDS.svg", width=10, height=7)
beta.NMDS 
dev.off()
# Usamos MDS/PCoA para disimilitud por pares entre objetos y la métrica de distancia es "jacccard"
psd5.ord1 <- ordinate(physeq = psd5, method = "MDS", distance = "jaccard")
beta.MDS <- plot_ordination(physeq = psd5, ordination = psd5.ord1, color = "SITE_ID") +
  theme_classic() +
  geom_point(size = 5) +
  geom_text(mapping = aes(label = SITE_ID), size = 4, vjust = 2, hjust = 1) + 
  geom_vline(xintercept = 0)+
  geom_hline(yintercept = 0)+
  labs(title="Beta diversity with MDS-Jaccard for the Calakmul samples obtained by rRNA 16s")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  scale_color_brewer(palette = "Set1") + 
  scale_fill_brewer(palette = "Set1")
beta.MDS
pdf("Resultados/PlotBetaMDS.pdf", width=10, height=7)
beta.MDS 
dev.off()
svg("Resultados/PlotBetaMDS.svg", width=10, height=7)
beta.MDS
dev.off()
```
### Diversidad beta y escalamiento multidimensional (Bray-Curtis, UniFrac, t-SNE)

En cuanto a diversidad beta podemos calcular similitud global a través de todas las muestras de interés o también podemos cuantificar la divergencia de un grupo y compararla con la divergencia de otro.
Veamos este último caso primero.
```{r}
# Calculamos las divergencias Ag1 Ag2 Ag3
psd5.Ag1 <- subset_samples(psd5, SITE_ID == "Ag1")
ref.Ag1 <- apply(abundances(psd5.Ag1), 1, median)
div.Ag1 <- divergence(psd5.Ag1, ref.Ag1)
#
psd5.Ag2 <- subset_samples(psd5, SITE_ID == "Ag2")
ref.Ag2 <- apply(abundances(psd5.Ag2), 1, median)
div.Ag2 <- divergence(psd5.Ag2, ref.Ag2)
#
psd5.Ag3 <- subset_samples(psd5, SITE_ID == "Ag3")
ref.Ag3 <- apply(abundances(psd5.Ag3), 1, median)
div.Ag3 <- divergence(psd5.Ag3, ref.Ag3)

# transformamos el resultado anterior en _dataframes_
data.frame(div.Ag1) -> df.div.Ag1
data.frame(div.Ag2) -> df.div.Ag2
data.frame(div.Ag3) -> df.div.Ag3
# Agregamos columnas a nuestros _dataframes_
mutate(df.div.Ag1, SITE_ID = "Ag1") -> df.div.Ag1
mutate(df.div.Ag2, SITE_ID = "Ag2") -> df.div.Ag2
mutate(df.div.Ag3, SITE_ID = "Ag3") -> df.div.Ag3
# Cambiamos los nombres de las columans de manera que sean iguales an ambos _dataframes_
colnames(df.div.Ag1) <- c("divergence", "SITE_ID")
colnames(df.div.Ag2) <- c("divergence", "SITE_ID")
colnames(df.div.Ag3) <- c("divergence", "SITE_ID")
# Los combinamos en un _dataframe_
rbind(df.div.Ag1, df.div.Ag2, df.div.Ag3) -> div.boxplot

# Y finalmente graficamos y realizamos una comparación estadística
p2 <- ggboxplot(data = div.boxplot, x = "SITE_ID", y = "divergence", fill = "SITE_ID", palette = c("#a6cee3", "#b2df8a", "#fdbf6f"))
p2 + stat_compare_means(comparisons = list(c("Ag1", "Ag2", "Ag3")))
```
Existen diferentes medidas de similitud (o disimilitud, i.e., 1 - similitud) disponibles que nos permiten entender las relaciones entre nuestras muestras. En general todas producen matrices de distancia comparables. El paquete phyloseq ofrece un gran número de medidas de distancia. Las más populares son UniFrac y Weighted UniFrac (medidas que consideran filogenia) y otras independientes de filogenia como: Jaccard, Manhattan, Euclidian, Bray-Curtis, Canberra, etc. Por otra parte, la matriz de distancia resultante no se usa en aislación sino que en conjunto con algún método de ordinación o escalamiento multidimensional (ordination). De nuevo, phyloseq ofrece un gran número de métodos entre los cuales se encuentran: detrended y canonical correspondence analysis, Double Principal Coordinate Analysis, Non-metric MultiDimenstional Scaling, y MDS/PCoA.
Probemos entonces hacer un análisis tipo PCoA con una matriz de distancia que considera las relaciones filogenéticas y otra que no.
```{r}
#Para poder meter el año como forma tuve que convertir en factor la variable año
psd5@sam_data@.Data[[6]] <- as.factor(psd5@sam_data@.Data[[6]])

psd5.mds.unifrac <- ordinate(psd5, method = "MDS", distance = "unifrac")
beta.MDS.Uni <- plot_ordination(physeq = psd5, ordination = psd5.mds.unifrac, color = "SITE_ID", shape = "YEAR") +
  theme_classic() +
  geom_point(size = 5) +
  geom_text(mapping = aes(label = SITE_ID), size = 4, vjust = 2, hjust = 1) + 
  geom_vline(xintercept = 0)+
  geom_hline(yintercept = 0)+
  labs(title="Beta diversity with MDS-Unifrac for the Calakmul samples obtained by rRNA 16s")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  scale_color_brewer(palette = "Set1") + 
  scale_fill_brewer(palette = "Set1")
beta.MDS.Uni
pdf("Resultados/PlotBetaMDSUni.pdf", width=10, height=7)
beta.MDS.Uni
dev.off()
svg("Resultados/PlotBetaMDSUni.svg", width=10, height=7)
beta.MDS.Uni 
dev.off()

psd5.mds.bray <- ordinate(psd5, method = "MDS", distance = "bray")
beta.MDS.Bray <- plot_ordination(physeq = psd5, ordination = psd5.mds.bray, color = "SITE_ID") +
theme_classic() +
  geom_point(size = 5) +
  geom_text(mapping = aes(label = SITE_ID), size = 4, vjust = 2, hjust = 1) + 
  geom_vline(xintercept = 0)+
  geom_hline(yintercept = 0)+
  labs(title="Beta diversity with MDS-Bray for the Calakmul samples obtained by rRNA 16s")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  scale_color_brewer(palette = "Set1") + 
  scale_fill_brewer(palette = "Set1")
beta.MDS.Bray
pdf("Resultados/PlotBetaMDSBray.pdf", width=10, height=7)
beta.MDS.Bray
dev.off()
svg("Resultados/PlotBetaMDSBray.svg", width=10, height=7)
beta.MDS.Bray 
dev.off()
```

Nota que los gráficos de dispersión donde se visualiza este tipo de análisis están escalados según la cantidad de variación que los ejes explican. En general lo que estos métodos pretenden hacer es tratar de encontrar el menor número de vectores matemáticos que maximicen la separación entre las muestras (puntos en el gráfico). Esto nace de la imposibilidad de graficar eficientemente datos multidimencionales. Volviendo a los ejes, estos no suman 100% porque hay otros ejes que no estamos usando para graficar y que contribuyen con el resto de la variación. Al graficarlos de manera simétrica distorsionaríamos las relaciones entre los puntos, especialmente si estamos comparando dos o más gráficos.

En específico para comunidades microbianas, el método de doble análisis de coordenadas principales o (DPCoA) es muy apropiado porque analiza conjuntamente dos tipos de datos: una tabla de disimilitud que representa diferencias entre especies y una matriz de abundancia que representa la distribución de especies entre las comunidades. El resultado final es un ensamble del espacio multidimensional que correlacionan las especies con las comunidades. El método fue publicado en 2004.
Veamos un ejemplo con nuestros datos.
```{r}
psd5.dpcoa.unifrac <- ordinate(psd5, method = "DPCoA", distance = "dpcoa")
beta.DPCoA <- plot_ordination(psd5, psd5.dpcoa.unifrac, color = "SITE_ID") + 
theme_classic() +
  geom_point(size = 5) +
  geom_text(mapping = aes(label = SITE_ID), size = 4, vjust = 2, hjust = 1) + 
  geom_vline(xintercept = 0)+
  geom_hline(yintercept = 0)+
  labs(title="Beta diversity with DPCoA for the Calakmul samples obtained by rRNA 16s")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  scale_color_brewer(palette = "Set1") + 
  scale_fill_brewer(palette = "Set1")
beta.DPCoA
pdf("Resultados/PlotBetaDPCoA.pdf", width=10, height=7)
beta.DPCoA
dev.off()
svg("Resultados/PlotBetaDPCoA.svg", width=10, height=7)
beta.DPCoA 
dev.off()
```
Ahora exploremos escalamiento multidimensional usando un método reciente conocido como t-SNE o t-Distributed Stochastic Neighbor Embedding. t-SNE difiere de otros métodos en que hace énfasis en las distancias locales en vez de las distancias globales, de esta forma generando una mayor resolución o separación entre los puntos o muestras.
```{r}
tsne_res <- tsne_phyloseq(psd5, distance= "dpcoa", perplexity = 8, verbose=0, rng_seed = 3901)
beta.DPCoA.tSNE <- plot_tsne_phyloseq(psd5, tsne_res, color = "SITE_ID") +
  theme_classic() +
  geom_point(size = 5) +
  geom_text(mapping = aes(label = SITE_ID), size = 4, vjust = 2, hjust = 1) + 
  geom_vline(xintercept = 0)+
  geom_hline(yintercept = 0)+
  labs(title="Beta diversity with DPCoA-tSNE for the Calakmul samples obtained by rRNA 16s")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  scale_color_brewer(palette = "Set1") + 
  scale_fill_brewer(palette = "Set1")
beta.DPCoA.tSNE
pdf("Resultados/PlotBetaDPCoAtSNE.pdf", width=10, height=7)
beta.DPCoA.tSNE
dev.off()
svg("Resultados/PlotBetaDPCoAtSNE.svg", width=10, height=7)
beta.DPCoA.tSNE
dev.off()
```

Ambos gráficos usan distintos métodos pero la misma medida de distancia. Los resultados son similares aunque las agrupaciones de puntos o muestras ocupan distinto espacio en el gráfico.
Otro uso de estas medidas es a través de la visualización de la densidad de las muestras en el espacio.
```{r}
method <- "tsne"
trans <- "hellinger"
distance <- "euclidean"

# Matriz de distancia
psd5 <- microbiome::transform(psd5, trans)

# Calculamos similitud entre muestras
dm <- vegdist(otu_table(psd5), distance)

# Corremos t-SNE
tsne_out <- Rtsne(dm, dims = 2, perplexity = 3) 
proj <- tsne_out$Y
rownames(proj) <- rownames(otu_table(psd5))
data.frame(proj) -> proj
proj$species <- sample_data(psd5)[,11]

pland <- plot_landscape(proj[,1:2], legend = T, size = 4) 
print(pland)
```

## Análisis de abundancias y visualizaciones
### Gráfico de barras apiladas

Una manera muy eficiente de obtener una visión general de la composición de las muestras es a través de un gráfico de barras apiladas. Existe una variadad de funciones que pueden hacer esto, sin embargo vamos a usar el paquete creado por un ex-miembro del laboratorio ya que tiene la ventaja de poder agrupar por hierarchical clustering las muestras entre otras ventajas.

```{r}
# Necesitamos obtener las taxa más abundantes, en este caso el top 10
top10 <- get_top_taxa(physeq_obj = psd5, n = 10, relative = T,
                       discard_other = T, other_label = "Other")
# Ya que no todas las taxa fueron clasificadas a nivel de especie, generamos etiquetas compuestas de distintos rangos taxonómicos para el gráfico
top10 <- name_taxa(top10, label = "", species = F, other_label = "Other")
# Finalmente graficamos
ptop10 <- fantaxtic_bar(top10, color_by = "Family", label_by = "Genus", facet_by = NULL, grid_by = NULL, other_color = "Grey") +
  theme_classic() +
  labs(title="Top 10 genus present in Calakmul samples obtained by rRNA 16s")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
ptop10

ptop10 <- fantaxtic_bar(top10, color_by = "Family", label_by = "Genus", facet_by = NULL, grid_by = NULL, other_color = "Grey") +
  theme_classic() +
  labs(title="Top 10 genus present in Calakmul samples obtained by rRNA 16s")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold")) +
  scale_x_discrete(labels= c("Ag3_Sep17","Ag2_Sep19","Ag1_Sep18","Ag1_Sep19","Ag3_Sep18",
                             "Ag3_Jun19","Ag2_Sep17","Ag3_Sep19","Ag1_Sep17","Ag2_Sep18")) # Cambiamos nombre de varibles de x
ptop10


pdf("Resultados/PlotTop10genus.pdf", width=10, height=7)
ptop10
dev.off()
svg("Resultados/PlotTop10genus.svg", width=10, height=7)
ptop10
dev.off()
```

Podemos ver que existen patrones relativamente claros en el gráfico solamente a partir de los colores. Aunque tenemos el nombre de las muestras bajo cada barra, sería mejor poder parcelar este gráfico de manera que quede claro qué muestras corresponden a qué especie de ballena.
La función fantaxtic_bar ofrece estas posibilidades a través de los argumentos facet_by y grid_by. Grafiquemos de nuevo.
```{r}
ptop10.2 <- fantaxtic_bar(top10, color_by = "Family", label_by = "Genus", facet_by = "SITE_ID", facet_cols = 3, grid_by = NULL, other_color = "Grey") +
  #theme_classic() +
  labs(x="Samples", y="Relative abundance",
       title="Top 10 genus present in Calakmul samples obtained by rRNA 16s")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
ptop10.2
pdf("Resultados/PlotTop10genus2.pdf", width=10, height=7)
ptop10.2
dev.off()
svg("Resultados/PlotTop10genus2.svg", width=10, height=7)
ptop10.2
dev.off()
```

Ahora queda más claro y se puede observar que las distintas especies de ballena tienen un patrón similar entre sí que es diferente entre las otras, con algunas excepciones. 

### Diferentes visualizaciones de abundancias
Veamos ahora otras herramientas que nos permiten examinar la composición de estas comunidades microbianas. El paquete ampvis2, desarrollado por Mads Albertsen y Kasper Skytte Andersen, nos permite hacer precisamente esto. Primero transformemos el objeto phyloseq con el cual hemos estado trabajando en un objeto ampvis2.

```{r}
# Necesitamos extraer la tabla de read counts y la tabla de taxonomía del objeto psd5
# Generamos una copia para no sobreescribir psd5
obj <- psd5
# Cambiamos la orientación de la otu_table
t(otu_table(obj)) -> otu_table(obj)
# Extraemos las tablas
otutable <- data.frame(OTU = rownames(phyloseq::otu_table(obj)@.Data),
                       phyloseq::otu_table(obj)@.Data,
                       phyloseq::tax_table(obj)@.Data,
                       check.names = FALSE
)
# Extraemos la metadada
metadata <- data.frame(phyloseq::sample_data(obj), 
                       check.names = FALSE
)

# ampvis2 requiere que 1) los rangos taxonómicos sean siete y vayan de Kingdom a Species y 2) la primera columna de la metadata sea el identificador de cada muestra
# Entonces duplicamos la columna Género y le cambiamos el nombre a Especie
otutable$Species = otutable$Genus
# Reordenamos la metadata
colnames(metadata)
rownames(metadata)
metadata$SAMPLE <- rownames(metadata)
colnames(metadata)
metadata <- metadata[,c("SAMPLE","ID","SITE","LATITUDE","LONGITUDE","MONTH","YEAR","pH","N_TOTAL","P_OLSEN","ORGANIC","TYPE","SITE_ID","FILES_R1","FILES_R2")]

# finalmente generamos el objeto ampvis
av2 <- amp_load(otutable, metadata)
```

Ahora echemos un vistazo a la estructura de las comunidades utilizando “rank abundance curves”.
```{r}
amp.abun <- amp_rankabundance(av2, group_by = "SITE_ID")+
  theme_classic() +
  labs(title="Relative abundance by number of accumulated readings")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))+
  scale_fill_brewer(palette = "Set1")+
  scale_color_brewer(palette = "Set1")
amp.abun
pdf("Resultados/PlotAmpAbun.pdf", width=10, height=7)
amp.abun 
dev.off()
svg("Resultados/PlotAmpAbun.svg", width=10, height=7)
amp.abun
dev.off()
```

El gráfico nos muestra que en la medida que vamos sumando las taxa de mayor a menor abundancia (Rank Abundance) la abundancia de reads cumulativa va aumentando. Lo importante de observar es la forma de la curva. Una curva que sube rápidamente nos indica que las comunidades están dominadas por unas cuantas taxa. En cambio, lo que observamos en nuestros datos es que las taxa más abundantes solamente dan cuenta de aproximadamente el 25% de la abundancia cumulativa de reads.
Veamos ahora qué taxa corresponde a ese 25%. Para esto podemos usar la función amp_heatmap.

```{r}
amp.HM.PhyGen <- amp_heatmap(av2, 
            group_by = "SITE_ID", 
            facet_by = "SITE_ID", 
            plot_values = TRUE,
            tax_show = 15,
            tax_aggregate = "Genus",
            tax_add = "Phylum",
            #color_vector = c("lightblue3", "olivedrab3"),
            plot_colorscale = "sqrt",
            plot_legendbreaks = c(1, 5, 10))+
  labs(title="Relative abundance for Phylum and genus")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
amp.HM.PhyGen
pdf("Resultados/PlotAmpHMPhyGen.pdf", width=10, height=7)
amp.HM.PhyGen 
dev.off()
svg("Resultados/PlotAmpHMPhyGen.svg", width=10, height=7)
amp.HM.PhyGen
dev.off()

amp.HM.Phy <- amp_heatmap(av2, 
            group_by = "SITE_ID", 
            facet_by = "SITE_ID", 
            plot_values = TRUE,
            tax_show = 15,
            tax_aggregate = "Phylum",
            plot_colorscale = "sqrt",
            plot_legendbreaks = c(1, 5, 10))+
  labs(title="Relative abundance for Phylum")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
amp.HM.Phy
pdf("Resultados/PlotAmpHMPhy.pdf", width=10, height=7)
amp.HM.Phy 
dev.off()
svg("Resultados/PlotAmpHMPhy.svg", width=10, height=7)
amp.HM.Phy
dev.off()

amp.HM.Gen <- amp_heatmap(av2, 
            group_by = "SITE_ID", 
            facet_by = "SITE_ID", 
            plot_values = TRUE,
            tax_show = 15,
            tax_aggregate = "Genus",
            plot_colorscale = "sqrt",
            plot_legendbreaks = c(1, 5, 10))+
  labs(title="Relative abundance for Genus")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))
amp.HM.Gen
pdf("Resultados/PlotAmpHMGen.pdf", width=10, height=7)
amp.HM.Gen
dev.off()
svg("Resultados/PlotAmpHMGen.svg", width=10, height=7)
amp.HM.Gen
dev.off()
```
Tenacibaculum parece ser el género más abundante para todas las muestras en todas los sitios de muestreo con excepción de Balaenoptera physalus que está dominada por Stenotrphomonas. Moraxella y distintas variantes de Cardiobacteriaceae de género no conocido. Justamente estos resultados se ajustan a lo conocido para cetáceos y otros mamíferos marinos.
También podemos realizar una visualización similar pero usando Box Plots.
```{r}
amp.BP.PhyGen <- amp_boxplot(av2,
            group_by = "SITE_ID",
            tax_show = 15,
            tax_aggregate = "Genus",
            tax_add = "Phylum",
            adjust_zero = T,
            plot_log = T) +
  labs(title="Relative abundance for Phylum and genus")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))+
  scale_fill_brewer(palette = "Set1")+
  scale_color_brewer(palette = "Set1")
amp.BP.PhyGen
pdf("Resultados/PlotAmpBPPhyGen.pdf", width=10, height=7)
amp.BP.PhyGen
dev.off()
svg("Resultados/PlotAmpBPPhyGen.svg", width=10, height=7)
amp.BP.PhyGen
dev.off()

amp.BP.Phy <- amp_boxplot(av2,
            group_by = "SITE_ID",
            tax_show = 15,
            tax_aggregate = "Phylum",
            adjust_zero = T,
            plot_log = T)+
  labs(title="Relative abundance for Phylum")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))+
  scale_fill_brewer(palette = "Set1")+
  scale_color_brewer(palette = "Set1")
amp.BP.Phy
pdf("Resultados/PlotAmpBPPhy.pdf", width=10, height=7)
amp.BP.Phy
dev.off()
svg("Resultados/PlotAmpBPPhy.svg", width=10, height=7)
amp.BP.Phy
dev.off()

amp.BP.Gen <- amp_boxplot(av2,
            group_by = "SITE_ID",
            tax_show = 15,
            tax_aggregate = "Genus",
            adjust_zero = T,
            plot_log = T)+
  labs(title="Relative abundance for Genus")+
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))+
  scale_fill_brewer(palette = "Set1")+
  scale_color_brewer(palette = "Set1")
amp.BP.Gen
pdf("Resultados/PlotAmpBPGen.pdf", width=10, height=7)
amp.BP.Gen
dev.off()
svg("Resultados/PlotAmpBPGen.svg", width=10, height=7)
amp.BP.Gen
dev.off()
```
Veamos ahora si es que algunos de estos microorganismos están compartidos entre todas las muestras. Para esto debemos calcular el core microbiome o el conjunto de taxa compartidas entre un cierto umbral porcentual de muestras y de prevalencia intra-muestra.
```{r}
amp_core(av2, group_by = "SITE_ID",
  core_pct = 70,
  margin_plots = "xy",
  margin_plot_values_size = 3,
  widths = c(3, 1),
  heights = c(1, 3)
)
```
Y visto de otra manera en un diagrama de Venn.
```{r}
amp.Venn <- amp_venn(av2, group_by = "SITE_ID", cut_a = 0.01, cut_f = 50, text_size = 4)
amp.Venn
pdf("Resultados/PlotAmpVenn.pdf", width=10, height=7)
amp.Venn
dev.off()
svg("Resultados/PlotAmpVenn.svg", width=10, height=7)
amp.Venn
dev.off()
```

# Pheatmap
Para obtener los taxones dominantes, solo mantendremos las OTU cuyas lecturas sean > 5% de lecturas relativas
```{r}
# Como esta mi objeto inicial
psd5 = prune_taxa(keepTaxa, psd4)
psd5
head(psd5@tax_table@.Data)
# Necesitamos que nuestro objeto psd5@tax_table@.Data tenga la estructura
# En las filas estarán los OTUS y en columnas las MUESTRAS
head(psd5@otu_table@.Data) # Aquí esta mal, esta al contrario
summary(psd5@otu_table@.Data)

# Hacemos un nuevo objeto que tenga una transpuesta de psd5@otu_table@.Data
psd6 <- merge_phyloseq(otu_table(t(psd5@otu_table@.Data), taxa_are_rows = T), psd5@tax_table, psd5@sam_data, psd5@phy_tree, psd5@refseq)
head(psd6@otu_table@.Data)
summary(psd6@otu_table@.Data)
psd6
head(psd6@tax_table@.Data)
# Cortamos los OTUs a nivel de GENUS, aunque ya estaba a nivel de género
psd6.gene <- tax_glom(psd6,taxrank = rank_names(psd6)[6]) # Agrupa todos las especies de un mismo género en uno solo
summary(psd6.gene@otu_table@.Data)
head(psd6.gene@tax_table@.Data)
psd6.gene
head(psd6.gene@tax_table@.Data)
psd6.gene.top <- filter_taxa(psd6.gene, function(x) mean(x) > 100.0, TRUE)

# Lo hago en valores relativos
psd7.gene <- transform_sample_counts(psd6.gene, function(x) x*100 / sum(x))
psd7.gene.top <- filter_taxa(psd7.gene, function(x) mean(x) > 1.0, TRUE)
```

El paquete pheatmap necesista un dataframe como entrada, asi que haremos unos desde el objeto phyloseq
```{r}
#Absolutos
psd6.gene.frame <- as.data.frame(psd6.gene.top@otu_table@.Data)
dim(psd6.gene.frame)
sample_names(psd6.gene.top)
head(psd6.gene.top@otu_table@.Data)
head(psd6.gene.frame)
rownames(psd6.gene.frame) <- make.names(psd6.gene.top@tax_table@.Data[,6], unique = T)
#colnames(psd6.gene.frame) <- metadata$ID
head(psd6.gene.frame)
str(psd6.gene.frame)

#Relativos
psd7.gene.frame <- as.data.frame(psd7.gene.top@otu_table@.Data)
dim(psd7.gene.frame)
sample_names(psd7.gene.top)
head(psd7.gene.top@otu_table@.Data)
head(psd7.gene.frame)
rownames(psd7.gene.frame) <- make.names(psd7.gene.top@tax_table@.Data[,6], unique = T)
#colnames(psd7.gene.frame) <- metadata$ID
head(psd7.gene.frame)
str(psd7.gene.frame)
```

Ahora, necesitamos un nuevo marco de datos donde asignaremos los metadatos que queremos visualizar en el pheatmap
```{r}
my.col <- data.frame(YEAR=metadata$YEAR, row.names = rownames(metadata))
#my.col$ID <- ID=metadata$ID
#my.col$pH <- metadata$pH
#my.col$N_TOTAL <- metadata$N_TOTAL
#my.col$P_OLSEN <- metadata$P_OLSEN
#my.col$ORGANIC <- metadata$ORGANIC
my.col$SITE_ID <- metadata$SITE_ID
str(my.col)
```
Tambien generaremos una lista de colores
```{r}
my_color <- list(#ID=c("Ag2_Sep17"="antiquewhite", "Ag3_Sep17"="cadetblue1",
                  #    "Ag1_Sep17"="chartreuse", "Ag3_Sep18"="azure4", 
                  #    "Ag3_Jun19"="coral", "Ag2_Sep19"="bisque3",
                  #    "Ag2_Sep18"="bisque3", "Ag3_Sep19"="darkcyan",
                  #    "Ag1_Sep18"="darkmagenta", "Ag1_Sep19"="deepskyblue3"),
                 YEAR=c("2017"="deepskyblue3", "2018"="indianred4", "2019"="purple4"),
                 #pH=c("6.7"="#bababa", "6.1"="brown4", "6.2"="#377eb8"),
                 #N_TOTAL=c("0.22"="darkolivegreen", "0.29"="#984ea3", "0.36"="darkgoldenrod3"),
                 #P_OLSEN=c("13.5"="darkred", "4.0"="deeppink4", "29.6"="aquamarine4"),
                 #ORGANIC=c("13.5"="darkseagreen4", "24.2"="gold4", "12.0"="gray"),
                 SITE_ID=c("Ag1"="lightseagreen", "Ag2"="midnightblue", "Ag3"="mediumvioletred"))
```

Corremos pheatmap
```{r}
# Aboslutos
psd6.gene.pheatmap <- pheatmap(psd6.gene.frame,
         color = (c("#ffffff","#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0",
                    "#02818a","#016c59","#014636")), 
        cluster_cols = TRUE, 
        cutree_cols = 3, cutree_rows = 4, border_color ="#000000",
        annotation_col = my.col, annotation_colors = my_color)

pdf("Resultados/PlotGenePheatmapAbs.pdf", width=10, height=7)
psd6.gene.pheatmap
dev.off()
svg("Resultados/PlotGenePheatmapAbs.svg", width=10, height=7)
psd6.gene.pheatmap
dev.off()


# Relativos
psd7.gene.pheatmap <- pheatmap(psd7.gene.frame,
         color = (c("#ffffff","#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0",
                    "#02818a","#016c59","#014636")), 
        cluster_cols = TRUE, 
        cutree_cols = 3, cutree_rows = 4, border_color ="#000000",
        annotation_col = my.col, annotation_colors = my_color)

pdf("Resultados/PlotGenePheatmapRel.pdf", width=10, height=7)
psd7.gene.pheatmap
dev.off()
svg("Resultados/PlotGenePheatmapRel.svg", width=10, height=7)
psd7.gene.pheatmap
dev.off()
```

# Otros gráficos
Vamos a crear un data.frame con el que trabajaremos
```{r}
# Conversión de valores absolutos a relativos
head(psd5@otu_table@.Data) 
# Porcentaje serán valores relativos
V.Relativos = transform_sample_counts(psd5, function(x) x*100 / sum(x))
head(V.Relativos@otu_table@.Data)

# psmelt permite generar un data.frame a partir de un objeto de phyloseq
# Nos quedamos solo con "Genus"
glom.gene <- tax_glom(V.Relativos, taxrank = 'Genus')
head(glom.gene@tax_table@.Data)
# Valores relativos
V.Relativos <- psmelt(glom.gene)
head(V.Relativos)
str(V.Relativos)

# Nos quedamos solo con "Genus"
raw.gene <- tax_glom(psd5, taxrank = 'Genus')
head(raw.gene@tax_table@.Data)
# Valores absolutos
V.Absolutos <- psmelt(raw.gene)
head(V.Absolutos)
str(V.Absolutos)

V.Relativos$Genus[V.Relativos$Abundance < 1.0] <- "Genus < 1.0 % abund."
V.Relativos$Phylum[V.Relativos$Abundance < 1.0] <- "Phyla < 1.0 % abund."
V.Relativos$Family[V.Relativos$Abundance < 1.0] <- "Family < 1.0 % abund."
#V.Absolutos$Genus[V.Absolutos$Abundance < 1.0] <- "Genus < 1.0 % abund."
#V.Absolutos$Phylum[V.Absolutos$Abundance < 1.0] <- "Phyla < 1.0 % abund."
#V.Absolutos$Family[V.Absolutos$Abundance < 1.0] <- "Family < 1.0 % abund."
```

Ahora si creamos la tabla
```{r}
PB.PhyRelYear <- ggplot(data = V.Relativos, aes(x = Phylum, y = Abundance, fill = SITE_ID))+
  geom_bar(aes(), stat="identity", position = "fill") + 
  theme_classic() +
  labs(x="Phylum", y="Relative abundance",
       title = "Relative abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))+
  facet_grid(. ~ V.Relativos$YEAR)

PB.PhyRelSite <- ggplot(data = V.Relativos, aes(x = Phylum, y = Abundance, fill = SITE_ID))+
  geom_bar(aes(), stat="identity", position = "stack") + 
  theme_classic() +
  labs(x="Phylum", y="Relative abundance",
       title = "Relative abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))+
  facet_grid(. ~ V.Absolutos$YEAR)

pdf("Resultados/PB.PhyRelYear.pdf", width=10, height=7)
PB.PhyRelYear
dev.off()
svg("Resultados/PB.PhyRelYear.svg", width=10, height=7)
PB.PhyRelYear
dev.off()
pdf("Resultados/PB.PhyRelSite.pdf", width=10, height=7)
PB.PhyRelSite
dev.off()
svg("Resultados/PB.PhyRelSite.svg", width=10, height=7)
PB.PhyRelSite
dev.off()

###

PB.PhyAbsYear <- ggplot(data = V.Absolutos, aes(x = Phylum, y = Abundance, fill = SITE_ID))+
  geom_bar(aes(), stat="identity", position = "stack") + 
  theme_classic() +
  labs(x="Phylum", y="Absolute abundance",
       title = "Absolute abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))+
  facet_grid(V.Relativos$SITE_ID ~ V.Relativos$YEAR)

PB.PhyAbsSite <- ggplot(data = V.Absolutos, aes(x = Phylum, y = Abundance, fill = SITE_ID))+
  geom_bar(aes(), stat="identity", position = "stack") + 
  theme_classic() +
  labs(x="Phylum", y="Absolute abundance",
       title = "Absolute abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))+
  facet_grid(V.Absolutos$SITE_ID ~ V.Absolutos$YEAR)

pdf("Resultados/PB.PhyAbsYear.pdf", width=10, height=7)
PB.PhyAbsYear
dev.off()
svg("Resultados/PB.PhyAbsYear.svg", width=10, height=7)
PB.PhyAbsYear
dev.off()
pdf("Resultados/PB.PhyAbsSite.pdf", width=10, height=7)
PB.PhyAbsSite
dev.off()
svg("Resultados/PB.PhyAbsSite.svg", width=10, height=7)
PB.PhyAbsSite
dev.off()
```

```{r}
PB.FamRelYear <- ggplot(data = V.Relativos, aes(x = Family, y = Abundance, fill = SITE_ID))+
  geom_bar(aes(), stat="identity", position = "fill") + 
  theme_classic() +
  labs(x="Family", y="Relative abundance",
       title = "Relative abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))+
  facet_grid(. ~ V.Relativos$YEAR)
pdf("Resultados/PB.FamRelYear.pdf", width=10, height=7)
PB.FamRelYear
dev.off()
svg("Resultados/PB.FamRelYear.svg", width=10, height=7)
PB.FamRelYear
dev.off()

PB.FamRelSite <- ggplot(data = V.Relativos, aes(x = Family, y = Abundance, fill = SITE_ID))+
  geom_bar(aes(), stat="identity", position = "fill") + 
  theme_classic() +
  labs(x="Family", y="Relative abundance",
       title = "Relative abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))+
  facet_grid(. ~ V.Relativos$SITE)
pdf("Resultados/PB.FamRelSite.pdf", width=10, height=7)
PB.FamRelSite
dev.off()
svg("Resultados/PB.FamRelSite.svg", width=10, height=7)
PB.FamRelSite
dev.off()

PB.FamAbsYear <- ggplot(data = V.Absolutos, aes(x = Family, y = Abundance, fill = SITE_ID))+
  geom_bar(aes(), stat="identity", position = "fill") + 
  theme_classic() +
  labs(x="Family", y="Absolute abundance",
       title = "Absolute abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))+
  facet_grid(. ~ V.Relativos$YEAR)
pdf("Resultados/PB.FamAbsYear.pdf", width=10, height=7)
PB.FamAbsYear
dev.off()
svg("Resultados/PB.FamAbsYear.svg", width=10, height=7)
PB.FamAbsYear
dev.off()

PB.FamAbsSite <- ggplot(data = V.Absolutos, aes(x = Family, y = Abundance, fill = SITE_ID))+
  geom_bar(aes(), stat="identity", position = "fill") + 
  theme_classic() +
  labs(x="Family", y="Absolute abundance",
       title = "Absolute abundance of analyzed samples") +
  theme(legend.position = "right", 
        legend.text = element_text(size=12, face="bold"),
        legend.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 12, face = "bold"),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14, face="bold"))+
  facet_grid(. ~ V.Relativos$SITE)
pdf("Resultados/PB.FamAbsSite.pdf", width=10, height=7)
PB.FamAbsSite
dev.off()
svg("Resultados/PB.FamAbsSite.svg", width=10, height=7)
PB.FamAbsSite
dev.off()
```

